<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
    <!-- Markdown support libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script src="/js/markdown-utils.js"></script>
</head>

<body>
    <div class="container">
        <h1>Welcome to AI Project Orchestrator</h1>
        <div style="float: right; margin-top: 10px;">
            <a href="/faq.html" style="text-decoration: none; color: #007bff; font-weight: bold;">System Analysis</a>
        </div>

        <div class="main-nav-buttons">
            <a href="/projects/create.html"><button>Create New Project</button></a>
            <a href="/projects/list.html"><button>View All Projects</button></a>
            <a href="/reviews/queue.html"><button>Go To Review Queue</button></a>
            <a href="/prompt-playground.html"><button>Prompt Playground</button></a>
        </div>

        <div class="dashboard-container">
            <div class="overview-section status-card">
                <h2>System Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-value" id="total-projects">0</span>
                        <span class="status-label">Total Projects</span>
                    </div>
                    <div class="status-item">
                        <span class="status-value" id="pending-reviews">0</span>
                        <span class="status-label">Pending Reviews</span>
                    </div>
                </div>
            </div>

            <div class="overview-section">
                <h2>Recent Projects</h2>
                <div id="recent-projects-list">
                    <p id="loading-recent">Loading recent projects...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch and display system status
            try {
                const projects = await window.APIClient.getProjects();
                const pendingReviews = await window.APIClient.getPendingReviews();

                document.getElementById('total-projects').textContent = projects.length;
                document.getElementById('pending-reviews').textContent = pendingReviews.length;

                displayRecentProjects(projects);

            } catch (error) {
                console.error("Failed to load dashboard data:", error);
                const overview = document.querySelector('.dashboard-container');
                overview.innerHTML = `<p style="color: red;">Could not load dashboard data: ${error.message}</p>`;
            }
        });

        function displayRecentProjects(projects) {
            const recentList = document.getElementById('recent-projects-list');
            document.getElementById('loading-recent').style.display = 'none';

            // Sort projects by creation date, newest first, and take the top 3
            const recentProjects = projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 3);

            if (recentProjects.length === 0) {
                recentList.innerHTML = '<p>No projects created yet.</p>';
                return;
            }

            recentProjects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'recent-project-item recent-project-card';
                projectItem.innerHTML = `
                    <div class="project-info">
                        <h3>${escapeHTML(project.name)}</h3>
                        <p class="project-description">${renderMarkdownToHTML(project.description)}</p>
                    </div>
                    <a href="/projects/workflow.html?projectId=${project.id}" class="action-link btn-primary">Continue Workflow</a>
                `;
                recentList.appendChild(projectItem);

                // Initialize truncation for description if long
                const descriptionEl = projectItem.querySelector('.project-description');
                if (descriptionEl) {
                    setTimeout(() => initTruncatedDescription(descriptionEl, 150), 0); // Delay for DOM
                }
            });
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }
    </script>

</html>