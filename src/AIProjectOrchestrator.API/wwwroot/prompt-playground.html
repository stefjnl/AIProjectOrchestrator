<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator - Prompt Playground</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
    <!-- Global Navigation Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-brand">
                <a href="/" class="header-logo">🤖 AI Project Orchestrator</a>
            </div>
            <nav class="header-nav">
                <a href="/projects/create.html" class="header-nav-item">Create Project</a>
                <a href="/projects/list.html" class="header-nav-item">View Projects</a>
                <a href="/reviews/queue.html" class="header-nav-item">Review Queue</a>
                <a href="/prompt-playground.html" class="header-nav-item active">Prompt Playground</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">Prompt Playground</h1>
                <p class="text-secondary">Experiment with AI prompts and test different models interactively</p>
            </div>

            <!-- Prompt Playground Interface -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Prompt Input Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-xl font-semibold text-primary">Prompt Editor</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="loadPromptTemplate()">Load
                                Template</button>
                            <button class="btn btn-sm btn-secondary" onclick="savePrompt()">Save Prompt</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearPrompt()">Clear</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="prompt-form" class="space-y-6">
                            <!-- Prompt Template Selection -->
                            <div class="form-group">
                                <label for="promptTemplate" class="form-label">Prompt Template</label>
                                <select id="promptTemplate" name="promptTemplate" class="form-control">
                                    <option value="">No template - start from scratch</option>
                                </select>
                                <div class="form-text">Choose a template to get started quickly</div>
                            </div>

                            <!-- AI Model Selection -->
                            <div class="form-group">
                                <label for="aiModel" class="form-label">AI Model</label>
                                <select id="aiModel" name="aiModel" class="form-control">
                                    <option value="claude">Claude (Recommended)</option>
                                    <option value="openrouter">OpenRouter</option>
                                    <option value="lmstudio">LM Studio (Local)</option>
                                    <option value="auto">Auto-select (Best available)</option>
                                </select>
                                <div class="form-text">Choose the AI model for prompt generation</div>
                            </div>

                            <!-- Prompt Content -->
                            <div class="form-group">
                                <label for="promptContent" class="form-label">Prompt Content *</label>
                                <textarea id="promptContent" name="promptContent" class="form-control font-mono"
                                    rows="12"
                                    placeholder="Enter your prompt here...

Example: Generate a comprehensive requirements analysis for a web application that allows users to create and manage their personal budget. Include features for expense tracking, budget planning, and financial goal setting."
                                    required></textarea>
                                <div class="form-text">Write your prompt with clear instructions and context</div>
                            </div>

                            <!-- Context/Background -->
                            <div class="form-group">
                                <label for="promptContext" class="form-label">Context/Background</label>
                                <textarea id="promptContext" name="promptContext" class="form-control" rows="4"
                                    placeholder="Provide any additional context, background information, or specific requirements..."></textarea>
                                <div class="form-text">Optional: Add context to help the AI understand your requirements
                                    better</div>
                            </div>

                            <!-- Parameters -->
                            <div class="form-group">
                                <label for="promptParameters" class="form-label">Parameters (JSON)</label>
                                <textarea id="promptParameters" name="promptParameters"
                                    class="form-control font-mono text-sm" rows="3"
                                    placeholder='{"temperature": 0.7, "max_tokens": 2000, "top_p": 0.9}'></textarea>
                                <div class="form-text">Optional: Custom parameters for the AI model (JSON format)</div>
                            </div>

                            <!-- Generate Button -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary btn-lg w-full">
                                    Generate Response
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Response Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-xl font-semibold text-primary">AI Response</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="copyResponse()">Copy</button>
                            <button class="btn btn-sm btn-secondary" onclick="exportResponse()">Export</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearResponse()">Clear</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="response-container">
                            <div class="text-secondary text-center py-12">
                                <div class="text-4xl mb-4">🤖</div>
                                <h3 class="text-lg font-semibold mb-2">AI Response</h3>
                                <p>Submit a prompt to see the AI-generated response here.</p>
                            </div>
                        </div>

                        <!-- Response Metadata -->
                        <div id="response-metadata" class="mt-6 pt-4 border-t border-gray-200 hidden">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <strong>Model:</strong> <span id="response-model">-</span>
                                </div>
                                <div>
                                    <strong>Tokens:</strong> <span id="response-tokens">-</span>
                                </div>
                                <div>
                                    <strong>Duration:</strong> <span id="response-duration">-</span>
                                </div>
                                <div>
                                    <strong>Timestamp:</strong> <span id="response-timestamp">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prompt History -->
            <div class="card mt-8">
                <div class="card-header">
                    <h2 class="text-xl font-semibold text-primary">Prompt History</h2>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="clearHistory()">Clear History</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportHistory()">Export History</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="prompt-history">
                        <div class="text-secondary text-center py-8">
                            <div class="text-3xl mb-4">📋</div>
                            <p>No prompt history yet. Start experimenting with prompts!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex justify-between mt-8">
                <div class="flex gap-3">
                    <button class="btn btn-secondary" onclick="loadExamplePrompt()">Load Example</button>
                    <button class="btn btn-secondary" onclick="testAllModels()">Test All Models</button>
                </div>
                <div class="flex gap-3">
                    <a href="/" class="btn btn-secondary">Back to Dashboard</a>
                    <a href="/projects/create.html" class="btn btn-primary">Create Project</a>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript Files -->
    <script src="/js/api.js"></script>
    <script src="/js/prompt-playground.js"></script>
    <script src="/js/markdown-utils.js"></script>
    <script src="/js/template-loader.js"></script>

    <script>
        // Prompt playground state
        let promptHistory = [];
        let currentResponse = null;

        // Initialize the prompt playground
        document.addEventListener('DOMContentLoaded', function () {
            loadPromptTemplates();
            loadPromptHistory();
            setupEventListeners();
        });

        // Load prompt templates
        async function loadPromptTemplates() {
            try {
                const templates = await window.APIClient.getPromptTemplates();
                const templateSelect = document.getElementById('promptTemplate');

                if (templates && templates.length > 0) {
                    templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        option.dataset.content = template.content;
                        option.dataset.context = template.context || '';
                        option.dataset.parameters = template.parameters || '';
                        templateSelect.appendChild(option);
                    });

                    templateSelect.addEventListener('change', function () {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.value) {
                            document.getElementById('promptContent').value = selectedOption.dataset.content || '';
                            document.getElementById('promptContext').value = selectedOption.dataset.context || '';
                            document.getElementById('promptParameters').value = selectedOption.dataset.parameters || '';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading prompt templates:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const promptForm = document.getElementById('prompt-form');
            if (promptForm) {
                promptForm.addEventListener('submit', handlePromptSubmit);
            }
        }

        // Handle prompt submission
        async function handlePromptSubmit(event) {
            event.preventDefault();

            const submitButton = this.querySelector('button[type="submit"]');
            const responseContainer = document.getElementById('response-container');
            const responseMetadata = document.getElementById('response-metadata');

            try {
                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="loading-spinner"></span> Generating...';

                // Get form data
                const formData = new FormData(this);
                const promptContent = formData.get('promptContent');
                const promptContext = formData.get('promptContext');
                const aiModel = formData.get('aiModel');
                const parametersText = formData.get('promptParameters');

                if (!promptContent.trim()) {
                    throw new Error('Please enter a prompt');
                }

                // Parse parameters
                let parameters = {};
                if (parametersText.trim()) {
                    try {
                        parameters = JSON.parse(parametersText);
                    } catch (e) {
                        throw new Error('Invalid JSON in parameters field');
                    }
                }

                // Prepare the request
                const requestData = {
                    promptContent: promptContent,
                    context: promptContext,
                    model: aiModel,
                    parameters: parameters
                };

                const startTime = Date.now();

                // Call the API
                const response = await window.APIClient.generatePromptFromPlayground(requestData);

                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // Store current response
                currentResponse = {
                    prompt: promptContent,
                    context: promptContext,
                    response: response.generatedContent || response.content || response,
                    model: aiModel,
                    timestamp: new Date().toISOString(),
                    duration: duration,
                    tokens: response.tokenCount || response.tokens || 'Unknown'
                };

                // Display response
                displayResponse(currentResponse);

                // Add to history
                addToHistory(currentResponse);

                // Show metadata
                responseMetadata.classList.remove('hidden');
                document.getElementById('response-model').textContent = aiModel;
                document.getElementById('response-tokens').textContent = currentResponse.tokens;
                document.getElementById('response-duration').textContent = `${duration}s`;
                document.getElementById('response-timestamp').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error('Error generating prompt:', error);

                responseContainer.innerHTML = `
                    <div class="text-danger text-center py-8">
                        <div class="text-3xl mb-4">❌</div>
                        <h3 class="text-lg font-semibold mb-2">Error Generating Response</h3>
                        <p class="text-secondary">${error.message}</p>
                        <div class="mt-4 text-sm text-secondary">
                            <strong>Troubleshooting tips:</strong>
                            <ul class="mt-2 space-y-1 text-left">
                                <li>• Check your API connection</li>
                                <li>• Verify the AI model is available</li>
                                <li>• Ensure your prompt is well-formed</li>
                                <li>• Try with different parameters</li>
                            </ul>
                        </div>
                    </div>
                `;
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = 'Generate Response';
            }
        }

        // Display response in the container
        function displayResponse(responseData) {
            const responseContainer = document.getElementById('response-container');

            if (typeof window.renderMarkdownToHTML === 'function') {
                responseContainer.innerHTML = window.renderMarkdownToHTML(responseData.response);
            } else {
                // Fallback markdown rendering
                responseContainer.innerHTML = responseData.response
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/g, '<em>$1</em>')
                    .replace(/`(.*)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            }
        }

        // Add to history
        function addToHistory(responseData) {
            promptHistory.unshift({
                ...responseData,
                id: Date.now().toString()
            });

            // Keep only last 10 items
            if (promptHistory.length > 10) {
                promptHistory = promptHistory.slice(0, 10);
            }

            // Save to localStorage
            localStorage.setItem('promptPlaygroundHistory', JSON.stringify(promptHistory));

            // Update history display
            updateHistoryDisplay();
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('prompt-history');

            if (promptHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-secondary text-center py-8">
                        <div class="text-3xl mb-4">📋</div>
                        <p>No prompt history yet. Start experimenting with prompts!</p>
                    </div>
                `;
                return;
            }

            historyContainer.innerHTML = promptHistory.map((item, index) => `
                <div class="history-item mb-4 p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-sm truncate" title="${escapeHtml(item.prompt)}">
                                ${escapeHtml(item.prompt.substring(0, 100))}${item.prompt.length > 100 ? '...' : ''}
                            </h4>
                            <div class="text-xs text-secondary mt-1">
                                ${item.model} • ${item.duration}s • ${new Date(item.timestamp).toLocaleString()}
                            </div>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button class="btn btn-xs btn-secondary" onclick="loadHistoryItem(${index})" title="Load">
                                📋
                            </button>
                            <button class="btn btn-xs btn-secondary" onclick="viewHistoryItem(${index})" title="View">
                                👁️
                            </button>
                            <button class="btn btn-xs btn-danger" onclick="deleteHistoryItem(${index})" title="Delete">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load prompt history from localStorage
        function loadPromptHistory() {
            const saved = localStorage.getItem('promptPlaygroundHistory');
            if (saved) {
                try {
                    promptHistory = JSON.parse(saved);
                    updateHistoryDisplay();
                } catch (e) {
                    console.error('Error loading prompt history:', e);
                    promptHistory = [];
                }
            }
        }

        // Utility functions
        function loadHistoryItem(index) {
            const item = promptHistory[index];
            if (item) {
                document.getElementById('promptContent').value = item.prompt;
                document.getElementById('promptContext').value = item.context || '';
                document.getElementById('aiModel').value = item.model;

                // Scroll to form
                document.getElementById('prompt-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function viewHistoryItem(index) {
            const item = promptHistory[index];
            if (item) {
                displayResponse(item);

                // Update metadata
                document.getElementById('response-metadata').classList.remove('hidden');
                document.getElementById('response-model').textContent = item.model;
                document.getElementById('response-tokens').textContent = item.tokens;
                document.getElementById('response-duration').textContent = `${item.duration}s`;
                document.getElementById('response-timestamp').textContent = new Date(item.timestamp).toLocaleString();

                // Scroll to response
                document.getElementById('response-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteHistoryItem(index) {
            if (confirm('Are you sure you want to delete this history item?')) {
                promptHistory.splice(index, 1);
                localStorage.setItem('promptPlaygroundHistory', JSON.stringify(promptHistory));
                updateHistoryDisplay();
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all prompt history? This cannot be undone.')) {
                promptHistory = [];
                localStorage.removeItem('promptPlaygroundHistory');
                updateHistoryDisplay();
            }
        }

        function exportHistory() {
            if (promptHistory.length === 0) {
                alert('No history to export');
                return;
            }

            const dataStr = JSON.stringify(promptHistory, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `prompt-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function copyResponse() {
            if (currentResponse && currentResponse.response) {
                navigator.clipboard.writeText(currentResponse.response).then(() => {
                    alert('Response copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy response:', err);
                    alert('Failed to copy response to clipboard');
                });
            } else {
                alert('No response to copy');
            }
        }

        function exportResponse() {
            if (currentResponse) {
                const dataStr = JSON.stringify(currentResponse, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `prompt-response-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            } else {
                alert('No response to export');
            }
        }

        function clearResponse() {
            document.getElementById('response-container').innerHTML = `
                <div class="text-secondary text-center py-12">
                    <div class="text-4xl mb-4">🤖</div>
                    <h3 class="text-lg font-semibold mb-2">AI Response</h3>
                    <p>Submit a prompt to see the AI-generated response here.</p>
                </div>
            `;
            document.getElementById('response-metadata').classList.add('hidden');
            currentResponse = null;
        }

        function clearPrompt() {
            if (confirm('Are you sure you want to clear the current prompt?')) {
                document.getElementById('prompt-form').reset();
                clearResponse();
            }
        }

        function loadPromptTemplate() {
            const templateSelect = document.getElementById('promptTemplate');
            if (templateSelect.value) {
                templateSelect.dispatchEvent(new Event('change'));
            } else {
                alert('Please select a template first');
            }
        }

        function savePrompt() {
            const promptContent = document.getElementById('promptContent').value;
            const promptContext = document.getElementById('promptContext').value;

            if (!promptContent.trim()) {
                alert('Please enter a prompt to save');
                return;
            }

            const promptName = prompt('Enter a name for this prompt:');
            if (promptName) {
                // Save to localStorage (in a real app, this would be saved to the server)
                const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
                savedPrompts.push({
                    name: promptName,
                    content: promptContent,
                    context: promptContext,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
                alert('Prompt saved successfully!');
            }
        }

        function loadExamplePrompt() {
            const examplePrompt = `Generate a comprehensive requirements analysis for a web application that allows users to create and manage their personal budget. 

Key Features to Include:
- User authentication and profile management
- Expense tracking with categories
- Budget planning with monthly/annual targets
- Financial goal setting and progress tracking
- Reports and analytics dashboard
- Data export capabilities

Technical Requirements:
- Responsive web design
- Secure data storage
- Real-time updates
- Mobile-friendly interface

Please provide:
1. Detailed functional requirements
2. User stories and acceptance criteria
3. Technical architecture recommendations
4. Database schema suggestions
5. Security considerations`;

            document.getElementById('promptContent').value = examplePrompt;
            document.getElementById('aiModel').value = 'claude';
            alert('Example prompt loaded! You can modify it before generating.');
        }

        async function testAllModels() {
            const promptContent = document.getElementById('promptContent').value;

            if (!promptContent.trim()) {
                alert('Please enter a prompt first');
                return;
            }

            const models = ['claude', 'openrouter', 'lmstudio'];
            const results = [];

            for (const model of models) {
                try {
                    const response = await window.APIClient.generatePromptFromPlayground({
                        promptContent: promptContent,
                        model: model,
                        parameters: {}
                    });

                    results.push({
                        model: model,
                        success: true,
                        response: response.generatedContent || response.content || response,
                        duration: 'N/A' // Would need timing logic
                    });
                } catch (error) {
                    results.push({
                        model: model,
                        success: false,
                        error: error.message
                    });
                }
            }

            // Display comparison results
            displayModelComparison(results);
        }

        function displayModelComparison(results) {
            const responseContainer = document.getElementById('response-container');

            let html = '<div class="space-y-6">';

            results.forEach(result => {
                html += `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-primary">${result.model.toUpperCase()}</h4>
                            <span class="status-badge ${result.success ? 'status-approved' : 'status-rejected'}">
                                ${result.success ? '✅ Success' : '❌ Failed'}
                            </span>
                        </div>
                `;

                if (result.success) {
                    html += `
                        <div class="markdown-content">
                            ${typeof window.renderMarkdownToHTML === 'function'
                            ? window.renderMarkdownToHTML(result.response.substring(0, 500) + '...')
                            : result.response.substring(0, 500) + '...'}
                        </div>
                    `;
                } else {
                    html += `
                        <div class="text-danger text-sm">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                }

                html += '</div>';
            });

            html += '</div>';

            responseContainer.innerHTML = html;
            document.getElementById('response-metadata').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>