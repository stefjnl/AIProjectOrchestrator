<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator - Workflow</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
    <!-- Global Navigation Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-brand">
                <a href="/" class="header-logo">🤖 AI Project Orchestrator</a>
            </div>
            <nav class="header-nav">
                <a href="/projects/create.html" class="header-nav-item">Create Project</a>
                <a href="/projects/list.html" class="header-nav-item active">View Projects</a>
                <a href="/reviews/queue.html" class="header-nav-item">Review Queue</a>
                <a href="/prompt-playground.html" class="header-nav-item">Prompt Playground</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">Project Workflow</h1>
                <p class="text-secondary">Manage your AI project through the 5-stage development pipeline</p>
            </div>

            <!-- Progress Indicator -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                    <span class="progress-steps" id="progressSteps">0 of 5 stages completed</span>
                </div>
            </div>

            <!-- Workflow Pipeline Visualization -->
            <div class="workflow-pipeline">
                <!-- Stage 1: Requirements Analysis -->
                <div class="pipeline-stage" id="stage-requirements">
                    <div class="stage-indicator not-started" id="milestone-requirements">
                        <span>1</span>
                    </div>
                    <div class="stage-label">Requirements Analysis</div>
                    <div class="stage-status status-not-started" id="requirementsStatus">Not Started</div>
                    <button class="btn btn-primary mt-4" id="startRequirementsBtn"
                        onclick="startRequirementsAnalysis()">
                        Start Requirements Analysis
                    </button>
                </div>

                <!-- Stage 2: Project Planning -->
                <div class="pipeline-stage" id="stage-planning">
                    <div class="stage-indicator not-started" id="milestone-planning">
                        <span>2</span>
                    </div>
                    <div class="stage-label">Project Planning</div>
                    <div class="stage-status status-not-started" id="planningStatus">Not Started</div>
                    <button class="btn btn-primary mt-4" id="startPlanningBtn" onclick="startProjectPlanning()"
                        disabled>
                        Start Project Planning
                    </button>
                </div>

                <!-- Stage 3: User Stories -->
                <div class="pipeline-stage" id="stage-stories">
                    <div class="stage-indicator not-started" id="milestone-stories">
                        <span>3</span>
                    </div>
                    <div class="stage-label">User Stories</div>
                    <div class="stage-status status-not-started" id="storiesStatus">Not Started</div>
                    <button class="btn btn-primary mt-4" id="startStoriesBtn" onclick="startStoryGeneration()" disabled>
                        Generate User Stories
                    </button>
                </div>

                <!-- Stage 4: Prompt Generation -->
                <div class="pipeline-stage" id="stage-prompts">
                    <div class="stage-indicator not-started" id="milestone-prompts">
                        <span>4</span>
                    </div>
                    <div class="stage-label">Prompt Generation</div>
                    <div class="stage-status status-not-started" id="promptStageStatus">Not Started</div>
                    <div class="mt-4 flex gap-2">
                        <button class="btn btn-primary" id="viewAllPromptsBtn" onclick="viewAllPrompts()" disabled>
                            View All Prompts
                        </button>
                        <button class="btn btn-secondary" id="downloadResultsBtn" onclick="downloadResults()" disabled>
                            Download Results
                        </button>
                    </div>
                </div>

                <!-- Stage 5: Code Generation -->
                <div class="pipeline-stage" id="stage-code">
                    <div class="stage-indicator not-started" id="milestone-code">
                        <span>5</span>
                    </div>
                    <div class="stage-label">Code Generation</div>
                    <div class="stage-status status-not-started" id="codeStatus">Not Started</div>
                    <button class="btn btn-primary mt-4" id="startCodeBtn" onclick="startCodeGeneration()" disabled>
                        Generate Code
                    </button>
                </div>
            </div>

            <!-- Workflow Details Section -->
            <div class="card mt-8">
                <div class="card-header">
                    <h2 class="text-xl font-semibold text-primary">Workflow Details</h2>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-secondary" onclick="refreshWorkflowStatus()">Refresh
                            Status</button>
                        <button class="btn btn-sm btn-secondary" onclick="resetWorkflow()">Reset Workflow</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="workflow-details">
                        <div class="loading-spinner"></div>
                        <p class="text-secondary text-center mt-4">Loading workflow details...</p>
                    </div>
                </div>
            </div>

            <!-- Story Management Section -->
            <div class="card mt-8" id="storiesContainer" style="display: none;">
                <div class="card-header">
                    <h2 class="text-xl font-semibold text-primary">Story Management</h2>
                    <button class="btn btn-sm btn-secondary" onclick="manageStories()">Manage All Stories</button>
                </div>
                <div class="card-body">
                    <div id="storiesList">
                        <div class="loading-spinner"></div>
                        <p class="text-secondary text-center mt-4">Loading stories...</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between mt-8">
                <div class="flex gap-3">
                    <a href="/projects/list.html" class="btn btn-secondary">Back to Projects</a>
                    <button class="btn btn-secondary" onclick="viewProjectDetails()">View Project Details</button>
                </div>
                <div class="flex gap-3">
                    <button class="btn btn-primary" onclick="exportWorkflow()">Export Workflow</button>
                    <button class="btn btn-success" onclick="completeWorkflow()">Complete Workflow</button>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript Files -->
    <script src="/js/api.js"></script>
    <script src="/js/workflow.js"></script>
    <script src="/js/markdown-utils.js"></script>
    <script src="/js/template-loader.js"></script>

    <script>
        // Initialize workflow manager when page loads
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id') || urlParams.get('projectId');

            if (!projectId || projectId === 'null' || projectId === 'undefined') {
                console.error('No project ID provided');
                alert('No project ID provided. Please select a project first.');
                window.location.href = '/projects/list.html';
                return;
            }

            // Initialize workflow manager
            window.workflowManager = new WorkflowManager(projectId);

            // Load initial workflow status
            loadWorkflowStatus();

            // Start polling for updates
            window.workflowManager.startPolling();
        });

        // Workflow stage functions - these must be preserved for existing JavaScript
        async function startRequirementsAnalysis() {
            if (window.workflowManager) {
                await window.workflowManager.startRequirementsAnalysis();
            }
        }

        async function startProjectPlanning() {
            if (window.workflowManager) {
                await window.workflowManager.startProjectPlanning();
            }
        }

        async function startStoryGeneration() {
            if (window.workflowManager) {
                await window.workflowManager.startStoryGeneration();
            }
        }

        async function startCodeGeneration() {
            if (window.workflowManager) {
                await window.workflowManager.startCodeGeneration();
            }
        }

        // Story prompt generation functions
        async function generateStoryPrompt(storyIndex) {
            if (window.workflowManager) {
                await window.workflowManager.generateStoryPrompt(storyIndex);
            }
        }

        async function viewPrompt(storyIndex) {
            if (window.workflowManager) {
                await window.workflowManager.viewPrompt(storyIndex);
            }
        }

        // Utility functions
        function viewAllPrompts() {
            const projectId = window.workflowManager?.projectId;
            if (projectId) {
                window.location.href = `/projects/stories-overview.html?projectId=${projectId}`;
            }
        }

        function downloadResults() {
            if (window.workflowManager) {
                window.workflowManager.downloadResults();
            }
        }

        function refreshWorkflowStatus() {
            if (window.workflowManager) {
                window.workflowManager.refreshState();
            }
        }

        function resetWorkflow() {
            if (confirm('Are you sure you want to reset this workflow? This action cannot be undone.')) {
                if (window.workflowManager) {
                    window.workflowManager.resetState();
                }
            }
        }

        function viewProjectDetails() {
            const projectId = window.workflowManager?.projectId;
            if (projectId) {
                window.open(`/projects/overview.html?id=${projectId}`, '_blank');
            }
        }

        function manageStories() {
            const projectId = window.workflowManager?.projectId;
            if (projectId) {
                window.location.href = `/projects/stories-overview.html?projectId=${projectId}`;
            }
        }

        function exportWorkflow() {
            if (window.workflowManager) {
                window.workflowManager.exportWorkflow();
            }
        }

        function completeWorkflow() {
            if (confirm('Are you sure you want to mark this workflow as complete?')) {
                if (window.workflowManager) {
                    window.workflowManager.completeWorkflow();
                }
            }
        }

        // Load workflow status
        async function loadWorkflowStatus() {
            try {
                const projectId = window.workflowManager?.projectId;
                if (!projectId) return;

                const response = await window.APIClient.getWorkflowStatus(projectId);

                // Update workflow details
                const detailsContainer = document.getElementById('workflow-details');
                detailsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Project Information</h3>
                            <div class="space-y-2">
                                <div><strong>Project ID:</strong> ${projectId}</div>
                                <div><strong>Current Stage:</strong> ${response.currentStage || 'Unknown'}</div>
                                <div><strong>Overall Status:</strong> <span class="status-badge">${response.status || 'Unknown'}</span></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Stage Progress</h3>
                            <div class="space-y-2">
                                <div><strong>Requirements:</strong> <span class="status-badge">${response.requirementsAnalysis?.isApproved ? 'Approved' : response.requirementsAnalysis?.isPending ? 'Pending' : 'Not Started'}</span></div>
                                <div><strong>Planning:</strong> <span class="status-badge">${response.projectPlanning?.isApproved ? 'Approved' : response.projectPlanning?.isPending ? 'Pending' : 'Not Started'}</span></div>
                                <div><strong>Stories:</strong> <span class="status-badge">${response.storyGeneration?.isApproved ? 'Approved' : response.storyGeneration?.isPending ? 'Pending' : 'Not Started'}</span></div>
                                <div><strong>Prompts:</strong> <span class="status-badge">${response.promptGeneration?.completionPercentage === 100 ? 'Complete' : response.promptGeneration?.storyPrompts?.length > 0 ? 'In Progress' : 'Not Started'}</span></div>
                            </div>
                        </div>
                    </div>
                `;

                // Show stories container if stories are approved
                if (response.storyGeneration?.isApproved) {
                    document.getElementById('storiesContainer').style.display = 'block';
                    loadStoriesList();
                }

            } catch (error) {
                console.error('Error loading workflow status:', error);

                // Handle specific error cases
                let errorMessage = error.message;
                let userMessage = 'Failed to load workflow status.';

                if (error.message.includes('404')) {
                    errorMessage = 'Project not found. The project may not exist or may have been deleted.';
                    userMessage = 'Project not found. Please check if the project ID is correct or create a new project.';
                } else if (error.message.includes('Network error')) {
                    errorMessage = 'Network connection issue. Please check if the backend is running.';
                    userMessage = 'Unable to connect to the server. Please ensure the backend is running and try again.';
                }

                document.getElementById('workflow-details').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error Loading Workflow Status</h4>
                        <p>${userMessage}</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="window.location.href='/projects/list.html'">View Projects</button>
                            <button class="btn btn-secondary" onclick="window.location.href='/projects/create.html'">Create New Project</button>
                        </div>
                    </div>
                `;

                // Stop polling on persistent errors
                if (window.workflowManager) {
                    window.workflowManager.stopPolling();
                }
            }
        }

        // Load stories list
        async function loadStoriesList() {
            try {
                const projectId = window.workflowManager?.projectId;
                if (!projectId) return;

                const workflowStatus = await window.APIClient.getWorkflowStatus(projectId);
                if (workflowStatus.storyGeneration?.generationId) {
                    const stories = await window.APIClient.getStories(workflowStatus.storyGeneration.generationId);

                    const storiesContainer = document.getElementById('storiesList');
                    if (stories.length === 0) {
                        storiesContainer.innerHTML = `
                            <div class="text-center py-8">
                                <div class="text-3xl mb-4">📚</div>
                                <h3 class="text-lg font-semibold mb-2">No Stories Yet</h3>
                                <p class="text-secondary">Stories will appear here once they are generated in the workflow.</p>
                            </div>
                        `;
                        return;
                    }

                    storiesContainer.innerHTML = stories.map((story, index) => `
                        <div class="story-item mb-4 p-4 border rounded-lg hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-primary">${story.Title || `Story ${index + 1}`}</h4>
                                <span class="status-badge ${(story.Status || 'draft').toLowerCase()}">${story.Status || 'Draft'}</span>
                            </div>
                            <p class="text-secondary text-sm mb-3">${story.Description || 'No description available'}</p>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="generateStoryPrompt(${index})"
                                        ${story.Status === 'Approved' ? '' : 'disabled'}>
                                    Generate Prompt
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="viewPrompt(${index})"
                                        ${story.Status === 'Approved' ? '' : 'disabled'}>
                                    View Prompt
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    // No story generation ID available
                    document.getElementById('storiesList').innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-3xl mb-4">⏳</div>
                            <h3 class="text-lg font-semibold mb-2">Stories Not Generated Yet</h3>
                            <p class="text-secondary">Complete the Requirements Analysis and Project Planning stages first.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading stories:', error);

                // Handle specific error cases
                let userMessage = 'Failed to load stories.';
                if (error.message.includes('404')) {
                    userMessage = 'Stories not found. They may not be generated yet.';
                } else if (error.message.includes('Network error')) {
                    userMessage = 'Network connection issue. Please try again.';
                }

                document.getElementById('storiesList').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-3xl mb-4">❌</div>
                        <h3 class="text-lg font-semibold text-danger mb-2">Error Loading Stories</h3>
                        <p class="text-secondary mb-4">${userMessage}</p>
                        <button class="btn btn-primary" onclick="loadStoriesList()">Try Again</button>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>