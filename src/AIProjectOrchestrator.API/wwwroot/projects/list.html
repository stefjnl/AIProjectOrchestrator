<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator - Projects</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
    <!-- Global Navigation Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-brand">
                <a href="/" class="header-logo">ü§ñ AI Project Orchestrator</a>
            </div>
            <nav class="header-nav">
                <a href="/projects/create.html" class="header-nav-item">Create Project</a>
                <a href="/projects/list.html" class="header-nav-item active">View Projects</a>
                <a href="/reviews/queue.html" class="header-nav-item">Review Queue</a>
                <a href="/prompt-playground.html" class="header-nav-item">Prompt Playground</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">All Projects</h1>
                <p class="text-secondary">Manage and monitor your AI project workflows</p>
            </div>

            <!-- Filters and Actions -->
            <div class="card mb-8">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <!-- Search and Filters -->
                        <div class="flex flex-col sm:flex-row gap-4 flex-1">
                            <div class="flex-1 max-w-md">
                                <input type="text" id="searchInput" class="form-control"
                                    placeholder="Search projects by name or description...">
                            </div>
                            <select id="statusFilter" class="form-control w-full sm:w-auto">
                                <option value="">All Statuses</option>
                                <option value="not-started">Not Started</option>
                                <option value="in-progress">In Progress</option>
                                <option value="pending-review">Pending Review</option>
                                <option value="approved">Approved</option>
                                <option value="completed">Completed</option>
                            </select>
                            <select id="sortBy" class="form-control w-full sm:w-auto">
                                <option value="created-desc">Newest First</option>
                                <option value="created-asc">Oldest First</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                                <option value="status">By Status</option>
                            </select>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="refreshProjects()">
                                Refresh
                            </button>
                            <a href="/projects/create.html" class="btn btn-success">
                                + New Project
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Grid -->
            <div id="projects-container">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projects-grid">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-secondary">Loading projects...</p>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üìÅ</div>
                <h3 class="text-xl font-semibold text-primary mb-2">No Projects Found</h3>
                <p class="text-secondary mb-6">You haven't created any projects yet. Start by creating your first AI
                    project!</p>
                <a href="/projects/create.html" class="btn btn-primary btn-lg">
                    Create Your First Project
                </a>
            </div>

            <!-- Load More -->
            <div class="text-center mt-8">
                <button id="loadMoreBtn" class="btn btn-secondary hidden" onclick="loadMoreProjects()">
                    Load More Projects
                </button>
            </div>
        </div>
    </main>

    <!-- JavaScript Files -->
    <script src="/js/api.js"></script>
    <script src="/js/projects-list.js"></script>
    <script src="/js/markdown-utils.js"></script>
    <script src="/js/template-loader.js"></script>

    <script>
        // Global variables for project management
        let allProjects = [];
        let filteredProjects = [];
        let currentPage = 1;
        const projectsPerPage = 9;
        let isLoading = false;

        // Initialize the projects list page
        document.addEventListener('DOMContentLoaded', function () {
            loadProjects();
            setupEventListeners();
        });

        // Load projects from API
        async function loadProjects() {
            if (isLoading) return;

            isLoading = true;
            const projectsContainer = document.getElementById('projects-grid');

            try {
                // Show loading state
                projectsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-secondary">Loading projects...</p>
                    </div>
                `;

                // Fetch projects from API
                const projects = await window.APIClient.getProjects();
                allProjects = projects || [];

                // Apply initial filters and render
                applyFilters();

            } catch (error) {
                console.error('Error loading projects:', error);
                projectsContainer.innerHTML = `
                    <div class="col-span-full">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <div class="text-3xl mb-4">‚ùå</div>
                                <h3 class="text-lg font-semibold text-danger mb-2">Error Loading Projects</h3>
                                <p class="text-secondary mb-4">${error.message}</p>
                                <button class="btn btn-primary" onclick="loadProjects()">Try Again</button>
                            </div>
                        </div>
                    </div>
                `;
            } finally {
                isLoading = false;
            }
        }

        // Apply filters and sorting
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // Filter projects
            filteredProjects = allProjects.filter(project => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    project.name.toLowerCase().includes(searchTerm) ||
                    (project.description && project.description.toLowerCase().includes(searchTerm));

                // Status filter
                let matchesStatus = true;
                if (statusFilter) {
                    matchesStatus = getProjectStatus(project).toLowerCase().replace(/\s+/g, '-') === statusFilter;
                }

                return matchesSearch && matchesStatus;
            });

            // Sort projects
            filteredProjects.sort((a, b) => {
                switch (sortBy) {
                    case 'created-desc':
                        return new Date(b.createdAt || b.created_at || 0) - new Date(a.createdAt || a.created_at || 0);
                    case 'created-asc':
                        return new Date(a.createdAt || a.created_at || 0) - new Date(b.createdAt || b.created_at || 0);
                    case 'name-asc':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'name-desc':
                        return (b.name || '').localeCompare(a.name || '');
                    case 'status':
                        return getProjectStatus(a).localeCompare(getProjectStatus(b));
                    default:
                        return 0;
                }
            });

            // Reset pagination
            currentPage = 1;
            renderProjects();
        }

        // Get project status for display
        function getProjectStatus(project) {
            // Determine status based on workflow progress
            if (project.status === 'Completed') return 'Completed';
            if (project.status === 'Approved') return 'Approved';
            if (project.status === 'Pending Review') return 'Pending Review';
            if (project.status === 'In Progress') return 'In Progress';

            // Check workflow stages
            if (project.workflowStatus) {
                if (project.workflowStatus.codeGeneration?.generationId) return 'Completed';
                if (project.workflowStatus.storyGeneration?.isApproved) return 'Approved';
                if (project.workflowStatus.storyGeneration?.isPending) return 'Pending Review';
                if (project.workflowStatus.requirementsAnalysis?.analysisId) return 'In Progress';
            }

            return 'Not Started';
        }

        // Render projects grid
        function renderProjects() {
            const projectsContainer = document.getElementById('projects-grid');
            const emptyState = document.getElementById('empty-state');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if (filteredProjects.length === 0) {
                projectsContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Calculate projects to show
            const startIndex = 0;
            const endIndex = currentPage * projectsPerPage;
            const projectsToShow = filteredProjects.slice(startIndex, endIndex);

            // Render project cards
            const projectsHTML = projectsToShow.map(project => createProjectCard(project)).join('');

            if (currentPage === 1) {
                projectsContainer.innerHTML = projectsHTML;
            } else {
                projectsContainer.innerHTML += projectsHTML;
            }

            // Show/hide load more button
            if (endIndex < filteredProjects.length) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }

        // Create project card HTML
        function createProjectCard(project) {
            const status = getProjectStatus(project);
            const statusClass = `status-${status.toLowerCase().replace(/\s+/g, '-')}`;
            const createdDate = new Date(project.createdAt || project.created_at || Date.now()).toLocaleDateString();
            const description = project.description || 'No description available';
            const truncatedDescription = description.length > 150 ? description.substring(0, 150) + '...' : description;

            return `
                <div class="project-card">
                    <div class="project-card-header">
                        <div class="flex-1">
                            <h3 class="project-card-title">${escapeHtml(project.name)}</h3>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-secondary" onclick="toggleProjectMenu('${project.id}')">
                                ‚ãØ
                            </button>
                            <div id="menu-${project.id}" class="dropdown-menu hidden">
                                <a href="/projects/workflow.html?id=${project.id}" class="dropdown-item">Continue Workflow</a>
                                <a href="/projects/overview.html?id=${project.id}" class="dropdown-item">View Details</a>
                                <button onclick="deleteProject('${project.id}')" class="dropdown-item text-danger">Delete</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="project-card-description">
                        ${escapeHtml(truncatedDescription)}
                    </div>
                    
                    <div class="project-card-meta">
                        <span>üìÖ Created: ${createdDate}</span>
                        <span>üÜî ID: ${project.id}</span>
                    </div>
                    
                    <div class="project-card-footer">
                        <div class="flex gap-2">
                            <a href="/projects/workflow.html?id=${project.id}" 
                               class="btn btn-sm btn-primary">
                                Continue Workflow
                            </a>
                            <a href="/projects/overview.html?id=${project.id}" 
                               class="btn btn-sm btn-secondary">
                                View Details
                            </a>
                        </div>
                        <button onclick="deleteProject('${project.id}')" 
                                class="btn btn-sm btn-danger">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }

            // Sort by
            const sortBy = document.getElementById('sortBy');
            if (sortBy) {
                sortBy.addEventListener('change', applyFilters);
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.add('hidden');
                    });
                }
            });
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleProjectMenu(projectId) {
            const menu = document.getElementById(`menu-${projectId}`);
            const isHidden = menu.classList.contains('hidden');

            // Close all other menus
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));

            // Toggle current menu
            if (isHidden) {
                menu.classList.remove('hidden');
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                return;
            }

            try {
                await window.APIClient.deleteProject(projectId);

                // Remove from local arrays
                allProjects = allProjects.filter(p => p.id !== projectId);
                applyFilters();

                // Show success message
                showNotification('Project deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting project:', error);
                showNotification(`Error deleting project: ${error.message}`, 'error');
            }
        }

        function refreshProjects() {
            loadProjects();
            showNotification('Projects refreshed', 'info');
        }

        function loadMoreProjects() {
            currentPage++;
            renderProjects();
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.textContent = message;

            // Add to document
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Add some CSS for dropdown menus
        const style = document.createElement('style');
        style.textContent = `
            .dropdown {
                position: relative;
            }
            
            .dropdown-menu {
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid var(--border-light);
                border-radius: var(--border-radius-base);
                box-shadow: var(--shadow-lg);
                min-width: 150px;
                z-index: 1000;
            }
            
            .dropdown-item {
                display: block;
                padding: var(--space-2) var(--space-4);
                color: var(--text-primary);
                text-decoration: none;
                font-size: var(--font-size-sm);
                transition: background-color var(--transition-fast);
            }
            
            .dropdown-item:hover {
                background-color: var(--bg-secondary);
            }
            
            .dropdown-item.text-danger {
                color: var(--color-danger);
            }
            
            .dropdown-item.text-danger:hover {
                background-color: rgba(239, 68, 68, 0.1);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>