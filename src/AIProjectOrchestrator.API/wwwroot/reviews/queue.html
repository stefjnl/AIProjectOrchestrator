<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator - Review Queue</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body>
    <!-- Global Navigation Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-brand">
                <a href="/" class="header-logo">ü§ñ AI Project Orchestrator</a>
            </div>
            <nav class="header-nav">
                <a href="/projects/create.html" class="header-nav-item">Create Project</a>
                <a href="/projects/list.html" class="header-nav-item">View Projects</a>
                <a href="/reviews/queue.html" class="header-nav-item active">Review Queue</a>
                <a href="/prompt-playground.html" class="header-nav-item">Prompt Playground</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header mb-8">
                <h1 class="text-3xl font-bold text-primary mb-2">Review Queue</h1>
                <p class="text-secondary">Review and approve AI-generated content from your project workflows</p>
            </div>

            <!-- Review Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-warning mb-2" id="pendingCount">0</div>
                        <div class="text-sm text-secondary">Pending Reviews</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-success mb-2" id="approvedCount">0</div>
                        <div class="text-sm text-secondary">Approved Today</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-danger mb-2" id="rejectedCount">0</div>
                        <div class="text-sm text-secondary">Rejected Today</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <div class="text-3xl font-bold text-primary mb-2" id="totalReviews">0</div>
                        <div class="text-sm text-secondary">Total Reviews</div>
                    </div>
                </div>
            </div>

            <!-- Filters and Actions -->
            <div class="card mb-8">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
                        <!-- Filters -->
                        <div class="flex flex-col sm:flex-row gap-4 flex-1">
                            <select id="reviewTypeFilter" class="form-control w-full sm:w-auto">
                                <option value="">All Review Types</option>
                                <option value="requirements">Requirements Analysis</option>
                                <option value="planning">Project Planning</option>
                                <option value="stories">User Stories</option>
                                <option value="prompts">Prompt Generation</option>
                                <option value="code">Code Generation</option>
                            </select>
                            <select id="projectFilter" class="form-control w-full sm:w-auto">
                                <option value="">All Projects</option>
                            </select>
                            <select id="dateFilter" class="form-control w-full sm:w-auto">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="refreshReviews()">
                                Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="exportReviews()">
                                Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Container -->
            <div id="reviews-container">
                <div id="loading" class="text-center py-12">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-secondary">Loading reviews...</p>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-xl font-semibold text-success mb-2">All Caught Up!</h3>
                <p class="text-secondary mb-6">No pending reviews at the moment. Great job keeping up with the workflow!
                </p>
                <a href="/projects/list.html" class="btn btn-primary">
                    View Projects
                </a>
            </div>
        </div>
    </main>

    <!-- JavaScript Files -->
    <script src="/js/api.js"></script>
    <script src="/js/reviews-list.js"></script>
    <script src="/js/markdown-utils.js"></script>
    <script src="/js/template-loader.js"></script>

    <script>
        // Enhanced review management
        let allReviews = [];
        let filteredReviews = [];
        let reviewStats = {
            pending: 0,
            approved: 0,
            rejected: 0,
            total: 0
        };

        // Initialize the reviews page
        document.addEventListener('DOMContentLoaded', function () {
            loadReviews();
            setupEventListeners();
            updateReviewStats();
        });

        // Load reviews from API
        async function loadReviews() {
            const reviewsContainer = document.getElementById('reviews-container');
            const loadingElement = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');

            try {
                loadingElement.style.display = 'block';
                emptyState.classList.add('hidden');

                // Fetch pending reviews from API
                const reviews = await window.APIClient.getPendingReviews();
                allReviews = reviews || [];

                // Apply filters and render
                applyFilters();
                updateReviewStats();

                // Load project filter options
                loadProjectFilterOptions();

            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewsContainer.innerHTML = `
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-4">‚ùå</div>
                            <h3 class="text-lg font-semibold text-danger mb-2">Error Loading Reviews</h3>
                            <p class="text-secondary mb-4">${error.message}</p>
                            <button class="btn btn-primary" onclick="loadReviews()">Try Again</button>
                        </div>
                    </div>
                `;
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Update review statistics
        function updateReviewStats() {
            const today = new Date().toDateString();

            reviewStats = {
                pending: allReviews.filter(r => r.status === 'Pending').length,
                approved: allReviews.filter(r => r.status === 'Approved' && new Date(r.updatedAt || r.updated_at || 0).toDateString() === today).length,
                rejected: allReviews.filter(r => r.status === 'Rejected' && new Date(r.updatedAt || r.updated_at || 0).toDateString() === today).length,
                total: allReviews.length
            };

            // Update UI
            document.getElementById('pendingCount').textContent = reviewStats.pending;
            document.getElementById('approvedCount').textContent = reviewStats.approved;
            document.getElementById('rejectedCount').textContent = reviewStats.rejected;
            document.getElementById('totalReviews').textContent = reviewStats.total;
        }

        // Apply filters
        function applyFilters() {
            const typeFilter = document.getElementById('reviewTypeFilter').value;
            const projectFilter = document.getElementById('projectFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            // Filter reviews
            filteredReviews = allReviews.filter(review => {
                // Type filter
                let matchesType = !typeFilter || review.reviewType === typeFilter;

                // Project filter
                let matchesProject = !projectFilter || review.projectId === projectFilter;

                // Date filter
                let matchesDate = true;
                if (dateFilter && dateFilter !== 'all') {
                    const reviewDate = new Date(review.createdAt || review.created_at || 0);
                    const now = new Date();

                    switch (dateFilter) {
                        case 'today':
                            matchesDate = reviewDate.toDateString() === now.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = reviewDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            matchesDate = reviewDate >= monthAgo;
                            break;
                    }
                }

                return matchesType && matchesProject && matchesDate;
            });

            renderReviews();
        }

        // Render reviews
        function renderReviews() {
            const reviewsContainer = document.getElementById('reviews-container');
            const emptyState = document.getElementById('empty-state');

            if (filteredReviews.length === 0) {
                reviewsContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            reviewsContainer.innerHTML = filteredReviews.map(review => createReviewCard(review)).join('');
        }

        // Create enhanced review card HTML
        function createReviewCard(review) {
            const createdDate = new Date(review.createdAt || review.created_at || 0).toLocaleDateString();
            const createdTime = new Date(review.createdAt || review.created_at || 0).toLocaleTimeString();
            const statusClass = `status-${(review.status || 'pending').toLowerCase()}`;
            const reviewType = review.reviewType || 'Unknown';
            const projectName = review.projectName || 'Unknown Project';

            // Truncate content for preview
            const content = review.content || 'No content available';
            const truncatedContent = content.length > 300 ? content.substring(0, 300) + '...' : content;

            return `
                <div class="review-card">
                    <div class="review-header">
                        <div class="flex-1">
                            <h3 class="review-title">
                                <a href="/reviews/details.html?id=${review.id}" class="review-link">
                                    ${escapeHtml(review.title || `${reviewType} Review`)}
                                </a>
                            </h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="review-status ${statusClass}">${review.status || 'Pending'}</span>
                                <span class="text-xs text-secondary">‚Ä¢</span>
                                <span class="text-xs text-secondary">${reviewType}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-secondary">${createdDate}</div>
                            <div class="text-xs text-tertiary">${createdTime}</div>
                        </div>
                    </div>
                    
                    <div class="review-meta">
                        <div class="meta-item">
                            <strong>Project:</strong> ${escapeHtml(projectName)}
                        </div>
                        <div class="meta-item">
                            <strong>Review ID:</strong> ${review.id}
                        </div>
                        <div class="meta-item">
                            <strong>Type:</strong> ${escapeHtml(reviewType)}
                        </div>
                        <div class="meta-item">
                            <strong>Created:</strong> ${createdDate} at ${createdTime}
                        </div>
                    </div>
                    
                    <div class="review-content">
                        <h4>Review Content</h4>
                        <div class="markdown-content">
                            ${renderMarkdown(truncatedContent)}
                        </div>
                        ${content.length > 300 ? `<p class="text-sm text-secondary mt-2"><a href="/reviews/details.html?id=${review.id}" class="text-primary">Read more...</a></p>` : ''}
                    </div>
                    
                    ${review.originalRequest ? `
                        <div class="review-content">
                            <h4>Original Request</h4>
                            <div class="markdown-content">
                                ${renderMarkdown(review.originalRequest)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="review-actions">
                        <button class="btn btn-primary" onclick="viewReviewDetails('${review.id}')">
                            View Details
                        </button>
                        ${review.status === 'Pending' ? `
                            <button class="btn btn-success" onclick="approveReview('${review.id}', '${review.reviewType}')">
                                Approve
                            </button>
                            <button class="btn btn-danger" onclick="rejectReview('${review.id}', '${review.reviewType}')">
                                Reject
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Load project filter options
        async function loadProjectFilterOptions() {
            try {
                const projects = await window.APIClient.getProjects();
                const projectFilter = document.getElementById('projectFilter');

                if (projects && projects.length > 0) {
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        projectFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading project filter options:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter event listeners
            const typeFilter = document.getElementById('reviewTypeFilter');
            const projectFilter = document.getElementById('projectFilter');
            const dateFilter = document.getElementById('dateFilter');

            if (typeFilter) typeFilter.addEventListener('change', applyFilters);
            if (projectFilter) projectFilter.addEventListener('change', applyFilters);
            if (dateFilter) dateFilter.addEventListener('change', applyFilters);
        }

        // Review action functions
        function viewReviewDetails(reviewId) {
            window.location.href = `/reviews/details.html?id=${reviewId}`;
        }

        async function approveReview(reviewId, reviewType) {
            if (!confirm(`Are you sure you want to approve this ${reviewType} review?`)) {
                return;
            }

            try {
                await window.APIClient.approveReview(reviewId);

                // Update local data
                const review = allReviews.find(r => r.id === reviewId);
                if (review) {
                    review.status = 'Approved';
                    review.updatedAt = new Date().toISOString();
                }

                // Re-render and update stats
                applyFilters();
                updateReviewStats();

                showNotification('Review approved successfully!', 'success');

            } catch (error) {
                console.error('Error approving review:', error);
                showNotification(`Error approving review: ${error.message}`, 'error');
            }
        }

        async function rejectReview(reviewId, reviewType) {
            const feedback = prompt(`Please provide feedback for rejecting this ${reviewType} review (optional):`);
            if (feedback === null) return; // User cancelled

            try {
                await window.APIClient.rejectReview(reviewId, feedback || 'No feedback provided');

                // Update local data
                const review = allReviews.find(r => r.id === reviewId);
                if (review) {
                    review.status = 'Rejected';
                    review.feedback = feedback;
                    review.updatedAt = new Date().toISOString();
                }

                // Re-render and update stats
                applyFilters();
                updateReviewStats();

                showNotification('Review rejected successfully!', 'success');

            } catch (error) {
                console.error('Error rejecting review:', error);
                showNotification(`Error rejecting review: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refreshReviews() {
            loadReviews();
            showNotification('Reviews refreshed', 'info');
        }

        function exportReviews() {
            // Export filtered reviews as JSON
            const dataStr = JSON.stringify(filteredReviews, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `reviews-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('Reviews exported successfully', 'success');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.textContent = message;

            // Add to document
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Enhanced markdown rendering (fallback if not available)
        function renderMarkdown(text) {
            if (typeof window.renderMarkdownToHTML === 'function') {
                return window.renderMarkdownToHTML(text);
            }

            // Basic markdown rendering fallback
            return text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*)\*/g, '<em>$1</em>')
                .replace(/`(.*)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }
    </script>
</body>

</html>