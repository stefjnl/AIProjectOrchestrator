<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Queue - AI Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="main-nav-buttons">
            <a href="/projects/create.html"><button>Create New Project</button></a>
            <a href="/projects/list.html"><button>View All Projects</button></a>
            <a href="/reviews/queue.html"><button>Go To Review Queue</button></a>
        </div>
        <a href="/index.html" class="back-link">&larr; Back to Home</a>
        <h1>Review Queue</h1>
        <div class="review-container">
            <div id="reviewList">
                <p class="no-reviews">Loading pending reviews...</p>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', loadPendingReviews);

        async function loadPendingReviews() {
            try {
                const reviews = await window.APIClient.getPendingReviews();
                const reviewList = document.getElementById('reviewList');

                if (reviews.length === 0) {
                    reviewList.innerHTML = '<p class="no-reviews">No pending reviews at this time.</p>';
                    return;
                }

                reviewList.innerHTML = reviews.map(review => `
                    <div class="review-card" id="review-${review.id}" role="article" aria-label="Review item">
                        <div class="review-project-info">
                            <h4>Project: ${review.projectName}</h4>
                            <p>${review.projectDescription}</p>
                            <span class="stage-badge">${review.projectStage}</span>
                            <small>Created: ${new Date(review.projectCreatedDate).toLocaleDateString()}</small>
                        </div>
                        <div class="review-header">
                            <h3>${review.serviceName}</h3>
                            <span class="pipeline-badge">${review.pipelineStage}</span>
                        </div>
                        <div class="review-content">${review.content}</div>
                        <div class="review-actions">
                            <button class="btn-primary approve" onclick="approveReview('${review.id}')"
                                    id="approve-${review.id}">Approve</button>
                            <button class="btn-secondary reject" onclick="rejectReview('${review.id}')"
                                    id="reject-${review.id}">Reject</button>
                            <button class="btn-danger delete" onclick="deleteReview('${review.id}')"
                                    id="delete-${review.id}">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviewList').innerHTML = '<p class="no-reviews">Error loading reviews: ' + error.message + '</p>';
            }
        }

        async function approveReview(reviewId) {
            const approveBtn = document.getElementById(`approve-${reviewId}`);
            const rejectBtn = document.getElementById(`reject-${reviewId}`);

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            approveBtn.textContent = 'Approving...';

            try {
                await window.APIClient.approveReview(reviewId);
                alert('Review approved successfully!');
                
                // Try to get the review details to determine which project it belongs to
                let projectId = null;
                let pipelineStage = null;
                try {
                    const review = await window.APIClient.getReview(reviewId);
                    // Extract project ID from metadata if available
                    if (review.metadata && review.metadata.ProjectId) {
                        projectId = review.metadata.ProjectId;
                    }
                    // Also capture pipeline stage for conditional redirect
                    if (review.pipelineStage) {
                        pipelineStage = review.pipelineStage;
                    }
                } catch (e) {
                    console.error('Error getting review details:', e);
                }

                // Fallback to URL parameter if available
                if (!projectId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    projectId = urlParams.get('projectId');
                    console.log('Using URL projectId for redirect:', projectId);
                }

                if (projectId && projectId !== 'unknown' && projectId !== 'null') {
                    // Pipeline-stage-aware redirect
                    if (pipelineStage === 'User Stories') {
                        window.location.href = `/projects/stories-overview.html?projectId=${encodeURIComponent(projectId)}`;
                    } else {
                        // For other stages, redirect to workflow
                        window.location.href = `/projects/workflow.html?projectId=${encodeURIComponent(projectId)}`;
                    }
                } else {
                    console.warn('No valid project ID found for redirect, reloading reviews');
                    await loadPendingReviews();
                }
            } catch (error) {
                alert('Error approving review: ' + error.message);
            } finally {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                approveBtn.textContent = 'Approve';
            }
        }

        async function rejectReview(reviewId) {
            const feedback = prompt('Please provide feedback for rejection:');
            if (!feedback) return; // User cancelled prompt

            const approveBtn = document.getElementById(`approve-${reviewId}`);
            const rejectBtn = document.getElementById(`reject-${reviewId}`);

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            rejectBtn.textContent = 'Rejecting...';

            try {
                await window.APIClient.rejectReview(reviewId, feedback);
                alert('Review rejected with feedback.');
                await loadPendingReviews(); // Reload reviews after rejection
            } catch (error) {
                alert('Error rejecting review: ' + error.message);
            } finally {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                rejectBtn.textContent = 'Reject';
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) return;

            const deleteBtn = document.getElementById(`delete-${reviewId}`);
            const approveBtn = document.getElementById(`approve-${reviewId}`);
            const rejectBtn = document.getElementById(`reject-${reviewId}`);

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            try {
                await window.APIClient.deleteReview(reviewId);
                alert('Review deleted successfully!');
                document.getElementById(`review-${reviewId}`).remove();
                if (document.querySelectorAll('.review-card').length === 0) {
                    document.getElementById('reviewList').innerHTML = '<p class="no-reviews">No pending reviews at this time.</p>';
                }
            } catch (error) {
                alert('Error deleting review: ' + error.message);
            } finally {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete';
            }
        }

        // Add init for projectId from URL
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            
            if (projectId && projectId !== 'unknown' && projectId !== 'null') {
                console.log('Review queue - Using URL projectId:', projectId);
                window.currentProjectId = projectId; // Global for use in approveReview
            } else {
                console.warn('Review queue - No projectId in URL:', projectId);
                window.currentProjectId = null;
            }
        });
    </script>
</body>
</html>