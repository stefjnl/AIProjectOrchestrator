# TDD Implementation Prompt: US-008 Human Review Interface & End-to-End Testing

## Role & Context
You are implementing **US-008: Human Review Interface** for the AI Project Orchestrator using **Test-Driven Development (TDD)**. This creates a simple web interface that enables real end-to-end testing of your complete three-stage AI orchestration pipeline.

## Current System Analysis Required
**CRITICAL**: Before writing any code, examine the existing infrastructure:

1. **Review existing API endpoints**: Study `ReviewController` methods for approve/reject functionality
2. **Understand current workflow**: Requirements → Planning → Stories with human review gates
3. **Examine API response formats**: Understand data structures for requirements, planning, stories
4. **Check existing static file serving**: Verify if Web API project supports wwwroot static files
5. **Test current endpoints**: Ensure all services respond correctly via Swagger/Postman

## TDD Implementation Requirements

### Phase 1: Write All Tests First (ALL MUST FAIL INITIALLY)
Create comprehensive test coverage for the interface components:

#### Unit Tests Required
```csharp
// ReviewInterfaceTests.cs - Minimum 8 tests
- GetPendingReviews_ReturnsFormattedReviewData()
- GetProjectWorkflowStatus_ValidProject_ReturnsStageProgress()
- ApproveReview_ValidReviewId_UpdatesStatusCorrectly()
- RejectReview_WithFeedback_UpdatesStatusWithComments()
- GetTestScenarios_ReturnsPredefineScenarioList()
- SubmitTestScenario_ValidInput_InitiatesWorkflow()
- GetWorkflowProgress_TracksMultiStageStatus()
- HandleConcurrentReviews_ManagesMultipleUsers()
```

#### Integration Tests Required
```csharp
// ReviewInterfaceIntegrationTests.cs - Minimum 6 tests
- GET_ReviewDashboard_ReturnsHTMLContent()
- POST_ApproveReview_UpdatesWorkflowStatus()
- GET_ProjectStatus_ShowsCurrentStage()
- POST_SubmitTestScenario_InitiatesEndToEndWorkflow()
- GET_StaticFiles_ServeCorrectly()
- EndToEnd_CompleteWorkflow_ProcessesSuccessfully()
```

### Phase 2: Enable Static File Serving
**CRITICAL**: Verify and configure static file serving in the Web API:

```csharp
// In Program.cs, ensure static file serving is enabled
app.UseStaticFiles(); // Should already exist or needs to be added

// Create wwwroot directory structure in API project:
// src/AIProjectOrchestrator.API/wwwroot/
```

### Phase 3: Create Enhanced Review Controller Methods
**IMPORTANT**: Only ADD methods, don't modify existing `ReviewController`:

```csharp
// Add to ReviewController.cs (API layer)
[HttpGet("dashboard-data")]
public async Task<ActionResult<ReviewDashboardData>> GetDashboardDataAsync(CancellationToken cancellationToken)
{
    // Return structured data for dashboard consumption
    // Include pending reviews from all services with context
    // Format: { pendingReviews: [...], workflowStatuses: [...] }
}

[HttpGet("workflow-status/{projectId}")]
public async Task<ActionResult<WorkflowStatus>> GetWorkflowStatusAsync(Guid projectId, CancellationToken cancellationToken)
{
    // Track complete workflow status across all services
    // Requirements status, Planning status, Stories status
    // Return current stage and next required action
}

[HttpPost("test-scenario")]
public async Task<ActionResult<TestScenarioResponse>> SubmitTestScenarioAsync([FromBody] TestScenarioRequest request, CancellationToken cancellationToken)
{
    // Accept predefined test scenarios
    // Initiate requirements analysis workflow
    // Return project ID for tracking
}
```

### Phase 4: Create Supporting Domain Models
Add models to support the interface without modifying existing ones:

```csharp
// Domain/Models/Review/ folder - ADD these models
public class ReviewDashboardData
{
    public List<PendingReviewItem> PendingReviews { get; set; } = new();
    public List<WorkflowStatusItem> ActiveWorkflows { get; set; } = new();
    public DateTime LastUpdated { get; set; }
}

public class PendingReviewItem
{
    public Guid ReviewId { get; set; }
    public string ServiceType { get; set; } = string.Empty; // "Requirements", "Planning", "Stories"
    public string Title { get; set; } = string.Empty;
    public string Content { get; set; } = string.Empty;
    public string OriginalRequest { get; set; } = string.Empty;
    public DateTime SubmittedAt { get; set; }
}

public class WorkflowStatusItem
{
    public Guid ProjectId { get; set; }
    public string ProjectTitle { get; set; } = string.Empty;
    public WorkflowStage CurrentStage { get; set; }
    public List<StageStatus> StageStatuses { get; set; } = new();
    public string NextAction { get; set; } = string.Empty;
}

public class StageStatus
{
    public string StageName { get; set; } = string.Empty;
    public string Status { get; set; } = string.Empty; // "Pending", "InProgress", "Completed", "Failed"
    public Guid? ReviewId { get; set; }
    public DateTime? CompletedAt { get; set; }
}

public enum WorkflowStage
{
    RequirementsAnalysis,
    ProjectPlanning,
    StoryGeneration,
    Completed
}

public class TestScenarioRequest
{
    public string ScenarioName { get; set; } = string.Empty;
    public string ProjectDescription { get; set; } = string.Empty;
    public string AdditionalContext { get; set; } = string.Empty;
    public string Constraints { get; set; } = string.Empty;
}

public class TestScenarioResponse
{
    public Guid ProjectId { get; set; }
    public Guid RequirementsAnalysisId { get; set; }
    public string Status { get; set; } = string.Empty;
    public string Message { get; set; } = string.Empty;
}
```

### Phase 5: Create Static HTML Interface Files

#### Main Dashboard (wwwroot/index.html)
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Orchestrator - Review Dashboard</title>
    <style>
        /* Simple, clean CSS styling */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #007acc; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #007acc; margin: 0; }
        .section { margin-bottom: 40px; }
        .review-item { border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin-bottom: 15px; background: #fafafa; }
        .review-item h3 { margin-top: 0; color: #333; }
        .review-content { max-height: 200px; overflow-y: auto; background: white; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .button-group { margin-top: 15px; }
        .btn { padding: 8px 16px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-primary { background: #007acc; color: white; }
        .workflow-stage { display: inline-block; padding: 5px 12px; margin: 2px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .stage-completed { background: #28a745; color: white; }
        .stage-pending { background: #ffc107; color: black; }
        .stage-failed { background: #dc3545; color: white; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-danger { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Project Orchestrator</h1>
            <p>Review Dashboard - Manage AI-generated outputs and track project workflows</p>
        </div>

        <div class="section">
            <h2>Quick Actions</h2>
            <button class="btn btn-primary" onclick="refreshDashboard()">Refresh Dashboard</button>
            <button class="btn btn-primary" onclick="window.open('/test-scenarios.html', '_blank')">Test Scenarios</button>
            <button class="btn btn-primary" onclick="window.open('/swagger', '_blank')">API Documentation</button>
        </div>

        <div class="section">
            <h2>Pending Reviews (<span id="pendingCount">Loading...</span>)</h2>
            <div id="pendingReviews" class="loading">Loading pending reviews...</div>
        </div>

        <div class="section">
            <h2>Active Workflows (<span id="workflowCount">Loading...</span>)</h2>
            <div id="activeWorkflows" class="loading">Loading active workflows...</div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>
```

#### Test Scenarios Page (wwwroot/test-scenarios.html)
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scenarios - AI Project Orchestrator</title>
    <link rel="stylesheet" href="index.html"> <!-- Reuse CSS styles -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Test Scenarios</h1>
            <p>Submit predefined project scenarios to test the complete AI orchestration pipeline</p>
            <a href="index.html" class="btn btn-primary">← Back to Dashboard</a>
        </div>

        <div class="section">
            <h2>Predefined Scenarios</h2>
            <div id="predefinedScenarios">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="section">
            <h2>Custom Scenario</h2>
            <form id="customScenarioForm">
                <div style="margin-bottom: 15px;">
                    <label>Project Title:</label><br>
                    <input type="text" id="projectTitle" style="width: 100%; padding: 8px;" placeholder="Enter project title">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Project Description:</label><br>
                    <textarea id="projectDescription" rows="4" style="width: 100%; padding: 8px;" placeholder="Describe your project idea..."></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Additional Context (Optional):</label><br>
                    <textarea id="additionalContext" rows="3" style="width: 100%; padding: 8px;" placeholder="Any additional context, constraints, or requirements..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit Custom Scenario</button>
            </form>
        </div>

        <div class="section">
            <h2>Recent Submissions</h2>
            <div id="recentSubmissions">
                <!-- Will show recently submitted scenarios and their status -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadPredefinedScenarios();
            loadRecentSubmissions();
        });
    </script>
</body>
</html>
```

#### JavaScript API Integration (wwwroot/app.js)
```javascript
// API Base Configuration
const API_BASE = window.location.origin;

// Dashboard Functions
async function loadDashboardData() {
    try {
        const response = await fetch(`${API_BASE}/api/review/dashboard-data`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        // Update pending reviews
        document.getElementById('pendingCount').textContent = data.pendingReviews.length;
        renderPendingReviews(data.pendingReviews);
        
        // Update active workflows
        document.getElementById('workflowCount').textContent = data.activeWorkflows.length;
        renderActiveWorkflows(data.activeWorkflows);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('Failed to load dashboard data. Please refresh the page.');
    }
}

function renderPendingReviews(reviews) {
    const container = document.getElementById('pendingReviews');
    
    if (reviews.length === 0) {
        container.innerHTML = '<p>No pending reviews at this time.</p>';
        return;
    }
    
    container.innerHTML = reviews.map(review => `
        <div class="review-item">
            <h3><span class="status-indicator status-warning"></span>${review.serviceType} Review</h3>
            <p><strong>Title:</strong> ${review.title}</p>
            <p><strong>Submitted:</strong> ${new Date(review.submittedAt).toLocaleString()}</p>
            
            <div class="review-content">
                <h4>Generated Content:</h4>
                <pre>${review.content}</pre>
                
                <h4>Original Request:</h4>
                <pre>${review.originalRequest}</pre>
            </div>
            
            <div class="button-group">
                <button class="btn btn-approve" onclick="approveReview('${review.reviewId}')">
                    Approve
                </button>
                <button class="btn btn-reject" onclick="rejectReview('${review.reviewId}')">
                    Reject
                </button>
            </div>
        </div>
    `).join('');
}

function renderActiveWorkflows(workflows) {
    const container = document.getElementById('activeWorkflows');
    
    if (workflows.length === 0) {
        container.innerHTML = '<p>No active workflows at this time.</p>';
        return;
    }
    
    container.innerHTML = workflows.map(workflow => `
        <div class="review-item">
            <h3><span class="status-indicator status-success"></span>${workflow.projectTitle}</h3>
            <p><strong>Current Stage:</strong> ${workflow.currentStage}</p>
            <p><strong>Next Action:</strong> ${workflow.nextAction}</p>
            
            <div style="margin: 10px 0;">
                ${workflow.stageStatuses.map(stage => `
                    <span class="workflow-stage stage-${stage.status.toLowerCase()}">
                        ${stage.stageName}: ${stage.status}
                    </span>
                `).join('')}
            </div>
            
            <button class="btn btn-primary" onclick="viewWorkflowDetails('${workflow.projectId}')">
                View Details
            </button>
        </div>
    `).join('');
}

// Review Actions
async function approveReview(reviewId) {
    if (!confirm('Are you sure you want to approve this review?')) return;
    
    try {
        const response = await fetch(`${API_BASE}/api/review/${reviewId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            showSuccess('Review approved successfully!');
            loadDashboardData(); // Refresh
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Error approving review:', error);
        showError('Failed to approve review. Please try again.');
    }
}

async function rejectReview(reviewId) {
    const feedback = prompt('Enter rejection feedback (optional):');
    if (feedback === null) return; // User cancelled
    
    try {
        const response = await fetch(`${API_BASE}/api/review/${reviewId}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: feedback || 'No feedback provided' })
        });
        
        if (response.ok) {
            showSuccess('Review rejected successfully!');
            loadDashboardData(); // Refresh
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Error rejecting review:', error);
        showError('Failed to reject review. Please try again.');
    }
}

// Test Scenarios
function loadPredefinedScenarios() {
    const scenarios = [
        {
            name: 'E-commerce Platform',
            description: 'Build an e-commerce platform for small businesses selling handmade goods',
            context: 'Focus on inventory management, order processing, and payment integration'
        },
        {
            name: 'University Course Management',
            description: 'Create a course management system for university professors',
            context: 'Integration with Canvas LMS, student grade tracking, assignment management'
        },
        {
            name: 'Task Management System',
            description: 'Build a task management application for software development teams',
            context: 'Agile workflow support, time tracking, team collaboration features'
        },
        {
            name: 'Healthcare Patient Portal',
            description: 'Develop a patient portal for medical practices',
            context: 'HIPAA compliance, appointment scheduling, medical record access'
        }
    ];
    
    const container = document.getElementById('predefinedScenarios');
    container.innerHTML = scenarios.map((scenario, index) => `
        <div class="review-item">
            <h3>${scenario.name}</h3>
            <p><strong>Description:</strong> ${scenario.description}</p>
            <p><strong>Context:</strong> ${scenario.context}</p>
            <button class="btn btn-primary" onclick="submitPredefinedScenario(${index})">
                Submit This Scenario
            </button>
        </div>
    `).join('');
}

async function submitPredefinedScenario(index) {
    const scenarios = [
        {
            name: 'E-commerce Platform',
            description: 'Build an e-commerce platform for small businesses selling handmade goods',
            context: 'Focus on inventory management, order processing, and payment integration'
        },
        {
            name: 'University Course Management',
            description: 'Create a course management system for university professors',
            context: 'Integration with Canvas LMS, student grade tracking, assignment management'
        },
        {
            name: 'Task Management System',
            description: 'Build a task management application for software development teams',
            context: 'Agile workflow support, time tracking, team collaboration features'
        },
        {
            name: 'Healthcare Patient Portal',
            description: 'Develop a patient portal for medical practices',
            context: 'HIPAA compliance, appointment scheduling, medical record access'
        }
    ];
    
    const scenario = scenarios[index];
    await submitTestScenario(scenario.name, scenario.description, scenario.context);
}

async function submitTestScenario(title, description, context) {
    try {
        const response = await fetch(`${API_BASE}/api/review/test-scenario`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                scenarioName: title,
                projectDescription: description,
                additionalContext: context,
                constraints: ''
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showSuccess(`Test scenario submitted! Project ID: ${result.projectId}`);
            loadRecentSubmissions();
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Error submitting scenario:', error);
        showError('Failed to submit test scenario. Please try again.');
    }
}

// Utility Functions
function refreshDashboard() {
    showSuccess('Refreshing dashboard...');
    loadDashboardData();
}

function showSuccess(message) {
    // Simple alert for now - can be enhanced with better UI
    alert(`Success: ${message}`);
}

function showError(message) {
    // Simple alert for now - can be enhanced with better UI
    alert(`Error: ${message}`);
}

function viewWorkflowDetails(projectId) {
    // Open detailed workflow view
    window.open(`${API_BASE}/project-status.html?id=${projectId}`, '_blank');
}
```

### Phase 6: Implementation Service Logic
**IMPORTANT**: Extend `ReviewService` with dashboard data methods, don't create new services:

```csharp
// Add to IReviewService (Domain layer)
Task<ReviewDashboardData> GetDashboardDataAsync(CancellationToken cancellationToken = default);
Task<WorkflowStatusItem?> GetWorkflowStatusAsync(Guid projectId, CancellationToken cancellationToken = default);

// Add to ReviewService (Application layer)
public async Task<ReviewDashboardData> GetDashboardDataAsync(CancellationToken cancellationToken)
{
    // Aggregate pending reviews from in-memory storage
    // Cross-reference with requirements/planning/story services to build workflow status
    // Return structured data for dashboard consumption
}
```

## Critical Implementation Requirements

### End-to-End Testing Workflow
Once implemented, you can test complete workflows:

1. **Submit Test Scenario**: Use predefined e-commerce scenario
2. **Review Requirements**: Approve/reject AI-generated requirements analysis
3. **Review Planning**: Approve/reject project planning output  
4. **Review Stories**: Approve/reject generated user stories
5. **Track Progress**: Monitor workflow status throughout process

### Performance Considerations
- Dashboard auto-refreshes every 30 seconds
- API calls use proper error handling and loading states
- Static files served efficiently by ASP.NET Core
- In-memory review storage supports concurrent access

### Quality Gates
- All tests must pass before implementation
- HTML validates and renders correctly in browsers
- JavaScript handles API errors gracefully  
- Interface works without external dependencies
- Complete end-to-end workflow processes successfully

## Success Verification
1. Navigate to `http://localhost:8080/index.html` shows dashboard
2. Submit test scenario initiates requirements analysis
3. Dashboard shows pending review for requirements
4. Approve/reject buttons update workflow status correctly
5. Complete workflow progression from idea to user stories
6. Multiple concurrent workflows handled properly

This creates a practical interface for testing your complete AI orchestration system while maintaining architectural integrity and providing valuable hands-on experience with real workflows.