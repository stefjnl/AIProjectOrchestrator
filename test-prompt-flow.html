<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Prompt Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .info {
            color: blue;
        }

        button {
            margin: 5px;
            padding: 10px;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Prompt Flow Test</h1>

    <div class="test-section">
        <h2>Step 1: Get User Stories</h2>
        <button onclick="getUserStories()">Get User Stories</button>
        <div id="stories-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Generate Prompt</h2>
        <input type="text" id="story-id" placeholder="Enter Story ID" style="width: 300px;">
        <button onclick="generatePrompt()">Generate Prompt</button>
        <div id="generation-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Check Story Status</h2>
        <button onclick="checkStoryStatus()">Check Story Status</button>
        <div id="status-result"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: View Generated Prompt</h2>
        <input type="text" id="prompt-id" placeholder="Enter Prompt ID" style="width: 300px;">
        <button onclick="viewPrompt()">View Prompt</button>
        <div id="prompt-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        async function getUserStories() {
            const resultDiv = document.getElementById('stories-result');
            try {
                const response = await fetch(`${API_BASE}/stories`);
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">Found ${data.length} stories</div>`;
                    if (data.length > 0) {
                        const story = data[0];
                        resultDiv.innerHTML += `
                            <pre>First story: ${JSON.stringify(story, null, 2)}</pre>
                            <p>Story ID: <strong>${story.id}</strong></p>
                            <p>Has Prompt: <strong>${story.hasPrompt}</strong></p>
                            <p>Prompt ID: <strong>${story.promptId || 'N/A'}</strong></p>
                        `;
                        document.getElementById('story-id').value = story.id;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.message || 'Failed to fetch stories'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function generatePrompt() {
            const storyId = document.getElementById('story-id').value;
            const resultDiv = document.getElementById('generation-result');

            if (!storyId) {
                resultDiv.innerHTML = '<div class="error">Please enter a story ID</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div class="info">Generating prompt...</div>';

                const response = await fetch(`${API_BASE}/prompt/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        storyId: storyId,
                        promptTemplateId: '550e8400-e29b-41d4-a716-446655440000', // Default template
                        includeContext: true
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">Prompt generated successfully!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    if (data.promptId) {
                        document.getElementById('prompt-id').value = data.promptId;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.message || 'Failed to generate prompt'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function checkStoryStatus() {
            const storyId = document.getElementById('story-id').value;
            const resultDiv = document.getElementById('status-result');

            if (!storyId) {
                resultDiv.innerHTML = '<div class="error">Please enter a story ID</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/stories/generation-results/${storyId}`);
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">Story status retrieved!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.message || 'Failed to get story status'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function viewPrompt() {
            const promptId = document.getElementById('prompt-id').value;
            const resultDiv = document.getElementById('prompt-result');

            if (!promptId) {
                resultDiv.innerHTML = '<div class="error">Please enter a prompt ID</div>';
                return;
            }

            try {
                resultDiv.innerHTML = '<div class="info">Retrieving prompt...</div>';

                const response = await fetch(`${API_BASE}/prompt/${promptId}`);
                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">Prompt retrieved successfully!</div>
                        <h3>Prompt Details:</h3>
                        <p><strong>Prompt ID:</strong> ${data.promptId}</p>
                        <p><strong>Story Generation ID:</strong> ${data.storyGenerationId}</p>
                        <p><strong>Story Index:</strong> ${data.storyIndex}</p>
                        <p><strong>Generated Prompt:</strong></p>
                        <pre style="background: #f9f9f9; padding: 10px; border-left: 3px solid #007acc;">${data.generatedPrompt}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.message || 'Failed to retrieve prompt'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Auto-load stories on page load
        window.addEventListener('load', getUserStories);
    </script>
</body>

</html>