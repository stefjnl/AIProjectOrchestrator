<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Projects - AI Project Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <a href="/index.html" class="back-link">&larr; Back to Home</a>
            <a href="/projects/create.html" class="create-btn-top"><button>Create New Project</button></a>
        </div>
        <h1>All Projects</h1>
        <div id="project-list-container">
            <table id="project-table">
                <thead>
                    <tr>
                        <th>Project Name</th>
                        <th>Description</th>
                        <th>Created Date</th>
                        <th>Current Stage</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="project-list">
                    <!-- Projects will be loaded here by JavaScript -->
                </tbody>
            </table>
            <div id="loading-message">Loading projects...</div>
            <div id="error-message" style="display: none; color: red;"></div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    const projects = await window.APIClient.getProjects();
                    await populateProjectList(projects);
                } catch (error) {
                    const errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = `Error loading projects: ${error.message}`;
                    errorMessage.style.display = 'block';
                } finally {
                    document.getElementById('loading-message').style.display = 'none';
                }
            });

            async function populateProjectList(projects) {
                const projectList = document.getElementById('project-list');
                if (projects.length === 0) {
                    projectList.innerHTML = '<tr><td colspan="6" class="no-projects">No projects found.</td></tr>';
                    return;
                }

                projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                for (const project of projects) {
                    const stageInfo = await getProjectStage(project);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${escapeHTML(project.name)}</td>
                        <td>${escapeHTML(project.description)}</td>
                        <td>${new Date(project.createdAt).toLocaleDateString()}</td>
                        <td>${stageInfo.stage}</td>
                        <td><span class="stage-status ${stageInfo.statusClass}">${stageInfo.status}</span></td>
                        <td>
                            <a href="/projects/workflow.html?projectId=${project.id}" class="action-link">Continue Workflow</a>
                            <button class="delete-btn" onclick="deleteProject(${project.id})" style="margin-left: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Delete</button>
                        </td>
                    `;
                    projectList.appendChild(row);
                }
            }

            async function getProjectStage(project) {
                // This function now makes API calls to determine the true status of each stage.
                const projectId = project.id;

                try {
                    const fullProject = await window.APIClient.getProject(projectId);
                    const requirements = fullProject.requirementsAnalyses?.[0];
                    const planning = fullProject.projectPlans?.[0];
                    const stories = fullProject.storyGenerations?.[0];
                    const code = fullProject.codeGenerations?.[0];

                    if (code?.execution.status === 'Approved') {
                        return { stage: 'Completed', status: 'Completed', statusClass: 'approved' };
                    }
                    if (code?.execution.status === 'Pending') {
                        return { stage: '4. Code Generation', status: 'Pending Review', statusClass: 'pending-review' };
                    }
                    if (stories?.execution.status === 'Approved') {
                        return { stage: '4. Code Generation', status: 'Not Started', statusClass: 'not-started' };
                    }
                    if (stories?.execution.status === 'Pending') {
                        return { stage: '3. User Stories', status: 'Pending Review', statusClass: 'pending-review' };
                    }
                    if (planning?.execution.status === 'Approved') {
                        return { stage: '3. User Stories', status: 'Not Started', statusClass: 'not-started' };
                    }
                    if (planning?.execution.status === 'Pending') {
                        return { stage: '2. Project Planning', status: 'Pending Review', statusClass: 'pending-review' };
                    }
                    if (requirements?.execution.status === 'Approved') {
                        return { stage: '2. Project Planning', status: 'Not Started', statusClass: 'not-started' };
                    }
                    if (requirements?.execution.status === 'Pending') {
                        return { stage: '1. Requirements Analysis', status: 'Pending Review', statusClass: 'pending-review' };
                    }
                } catch (e) {
                    console.error(`Could not determine stage for project ${project.id}`, e);
                    // Fallback to simplified logic on error
                    if (project.codeGenerationId) return { stage: '4. Code Generation', status: 'In Progress', statusClass: 'pending-review' };
                    if (project.storyGenerationId) return { stage: '3. User Stories', status: 'In Progress', statusClass: 'pending-review' };
                    if (project.projectPlanningId) return { stage: '2. Project Planning', status: 'In Progress', statusClass: 'pending-review' };
                    if (project.requirementsAnalysisId) return { stage: '1. Requirements Analysis', status: 'In Progress', statusClass: 'pending-review' };
                }

                return { stage: '1. Requirements Analysis', status: 'Not Started', statusClass: 'not-started' };
            }

            function escapeHTML(str) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }

            async function deleteProject(id) {
                if (!confirm(`Are you sure you want to delete this project and all related data? This action cannot be undone.`)) {
                    return;
                }

                try {
                    await window.APIClient.deleteProject(id);
                    // Remove the row from the table without full page reload
                    const row = document.querySelector(`tr:has(button[onclick="deleteProject(${id})"])`);
                    if (row) {
                        row.remove();
                        // If no projects left, show "No projects found"
                        if (document.querySelectorAll('#project-list tr').length === 0) {
                            document.getElementById('project-list').innerHTML = '<tr><td colspan="6" class="no-projects">No projects found.</td></tr>';
                        }
                    }
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.textContent = 'Project deleted successfully.';
                    successMsg.style.cssText = 'color: green; margin: 10px 0; padding: 5px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px;';
                    document.getElementById('project-list-container').insertBefore(successMsg, document.getElementById('project-table'));
                    setTimeout(() => successMsg.remove(), 3000);
                } catch (error) {
                    console.error('Delete failed:', error);
                    alert(`Failed to delete project: ${error.message}`);
                }
            }
        </script>
</body>
</html>
