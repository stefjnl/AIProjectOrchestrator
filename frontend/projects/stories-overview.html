<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stories & Prompts Management - AI Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="main-nav-buttons">
                <a href="/projects/create.html"><button>Create New Project</button></a>
                <a href="/projects/list.html"><button>View All Projects</button></a>
                <a href="/reviews/queue.html"><button>Go To Review Queue</button></a>
            </div>
            <h1 id="projectTitle">Stories Management</h1>
            <p id="projectDescription">Stories management workspace for prompt generation.</p>
        </div>

        <!-- Stories Management Interface -->
        <div id="summaryStats" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;"></div>
        <div id="storiesContainer" class="stories-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;"></div>
        <button id="backToWorkflow" class="primary-btn" style="margin: 20px 0;">‚Üê Back to Project Workflow</button>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/workflow.js"></script>
    <script>
        let workflowManager;

        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            
            if (!projectId) {
                alert('Project ID is required');
                window.location.href = '/projects/list.html';
                return;
            }

            workflowManager = new WorkflowManager(projectId);

            // Show loading state
            document.body.classList.add('loading');
            
            try {
                // Load state from API instead of localStorage
                await workflowManager.loadStateFromAPI();
                
                // Load project info
                const project = await window.APIClient.getProject(projectId);
                workflowManager.recordApiSuccess();
                document.getElementById('projectTitle').textContent = project.name;
                document.getElementById('projectDescription').textContent = project.description;

                // Load and render stories
                await loadAndRenderStories();

                // Start polling for updates
                workflowManager.startPolling();
                
                // Hide loading state
                document.body.classList.remove('loading');
                
            } catch (error) {
                console.error('Failed to initialize stories overview:', error);
                showError('Failed to load stories. Please try again.');
                document.body.classList.remove('loading');
            }

            // Set up back button - redirect to workflow page
            document.getElementById('backToWorkflow').addEventListener('click', function() {
                window.location.href = `/projects/workflow.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
            });

            // Trigger sync with workflow page
            if (typeof workflowManager.syncWithStoriesPage === 'function') {
                await workflowManager.syncWithStoriesPage();
            }

            // Page visibility refresh
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && workflowManager.state.enableStoriesMVP) {
                    workflowManager.refreshState().then(loadAndRenderStories).catch(console.error);
                }
            });
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                workflowManager.stopPolling();
            });
        });

        async function loadAndRenderStories() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');
            
            if (!workflowManager.state.storiesApproved || !workflowManager.state.storyGenerationId) {
                showError('No stories available. Please complete the story generation stage first.', projectId);
                return;
            }

            try {
                // Fetch stories from API
                const stories = await window.APIClient.getStories(workflowManager.state.storyGenerationId);
                workflowManager.recordApiSuccess();
                
                if (!stories || stories.length === 0) {
                    showError('No stories found for this project.', projectId);
                    return;
                }
                
                // Get prompt statuses for each story
                const storyPrompts = workflowManager.state.storyPrompts || [];
                
                // Debug logging for storyPrompts structure
                console.log('Raw storyPrompts data:', storyPrompts);
                if (storyPrompts.length > 0) {
                    console.log('First storyPrompt:', storyPrompts[0]);
                    console.log('Sample storyPrompt status:', storyPrompts[0]?.status, 'type:', typeof storyPrompts[0]?.status);
                }
                
                renderStoriesGrid(stories, storyPrompts);
                updateSummaryStats(stories, storyPrompts);
                
            } catch (error) {
                console.error('Error loading stories:', error);
                workflowManager.recordApiFailure();
                
                if (workflowManager.isApiDisabled()) {
                    showMaintenanceBanner();
                }
                
                if (error.message.includes('404')) {
                    showError('Stories data not found. The stories may not be approved yet.', projectId);
                } else {
                    showError('Failed to load stories from the server.', projectId);
                }
            }
        }

        function renderStoriesGrid(stories, storyPrompts) {
            const container = document.getElementById('storiesContainer');
            
            container.innerHTML = stories.map((story, index) => {
                const storyPrompt = storyPrompts.find(sp => sp.storyIndex === index);
                const status = storyPrompt?.status || 'Not Started';
                
                // Debug logging for status before getStatusClass
                console.log(`Status for story index ${index}:`, status, 'type:', typeof status, 'storyPrompt:', storyPrompt);
                
                const statusClass = getStatusClass(status);
                
                // Debug logging for story object structure
                console.log('Story object:', story);
                console.log('Story properties:', Object.keys(story));

                const title = story.Title || story.title || `Story ${index + 1}`;
                const asA = story.AsA || story.asA || 'undefined';
                const iWant = story.IWant || story.iWant || 'undefined';
                const soThat = story.SoThat || story.soThat || 'undefined';

                // Null safety for storyPrompt properties
                const isPromptApproved = !!(storyPrompt?.isApproved || false);
                const promptId = storyPrompt?.promptId || '';

                return `
                    <div class="story-card" data-story-index="${index}">
                        <div class="story-header">
                            <h3>Story ${index + 1}: ${title}</h3>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        <div class="story-content">
                            <p><strong>As a</strong> ${asA}</p>
                            <p><strong>I want</strong> ${iWant}</p>
                            <p><strong>So that</strong> ${soThat}</p>
                        </div>
                        <div class="story-actions">
                            <button onclick="generatePrompt(${index})" 
                                    ${isPromptApproved ? 'disabled' : ''}>
                                ${isPromptApproved ? 'Prompt Generated' : 'Generate Prompt'}
                            </button>
                            ${isPromptApproved ? 
                                `<button onclick="viewPrompt('${promptId}')">View Prompt</button>` : 
                                ''}
                        </div>
                    </div>
                `;
            }).join('');

            updateSummaryStats(stories, storyPrompts);
        }
        
        function getStatusClass(status) {
            if (!status || typeof status !== 'string') {
                console.warn('Invalid status value in getStatusClass:', status, 'type:', typeof status);
                return 'danger';
            }
            
            const lowerStatus = status.toLowerCase();
            switch(lowerStatus) {
                case 'approved': return 'success';
                case 'pending': 
                case 'pending review': return 'warning';
                case 'not started': 
                case 'notstarted': return 'secondary';
                case 'rejected': return 'danger';
                default: 
                    console.warn('Unknown status value:', lowerStatus);
                    return 'danger';
            }
        }

        function updateSummaryStats(stories, storyPrompts) {
            const summaryEl = document.getElementById('summaryStats');
            if (!summaryEl) return;

            const progress = workflowManager.getPromptCompletionProgress();
            summaryEl.innerHTML = `
                <strong>${progress.completed}/${progress.total} prompts approved</strong>
                ${progress.pending > 0 ? ` | ${progress.pending} pending review` : ''}
                ${progress.total > 0 ? ` | ${Math.round(progress.percentage)}% complete` : ''}
            `;
        }

        async function generatePrompt(storyIndex) {
            if (!workflowManager.state.storiesApproved) {
                alert('Stories must be approved before generating prompts.');
                return;
            }

            try {
                console.log('Generating prompt for story index:', storyIndex);
                
                const request = {
                    storyGenerationId: workflowManager.state.storyGenerationId,
                    storyIndex: storyIndex,
                    technicalPreferences: {}
                };
                
                const response = await window.APIClient.generatePrompt(request);
                workflowManager.recordApiSuccess();
                
                // Don't save state - will be updated by polling
                alert('Prompt generation submitted for review. Please check the review queue.');
                
                // Stories-specific refresh: load state without UI update
                await workflowManager.loadStateFromAPI();
                // Debug log after refresh
                console.log('State refreshed after prompt generation:', workflowManager.state);
                await loadAndRenderStories();
                
            } catch (error) {
                console.error('Error generating prompt:', error);
                workflowManager.recordApiFailure();
                if (workflowManager.isApiDisabled()) {
                    showMaintenanceBanner();
                }
                alert('Error generating prompt: ' + error.message);
            }
        }
        
        async function viewPrompt(promptId) {
            try {
                const prompt = await window.APIClient.getPrompt(promptId);
                workflowManager.recordApiSuccess();
                
                // Simple inline view for MVP
                const viewDiv = document.createElement('div');
                viewDiv.id = 'tempPromptView';
                viewDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;';
                
                viewDiv.innerHTML = `
                    <div style="background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow: auto; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3>Generated Prompt</h3>
                            <button onclick="closeTempView()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer;">Close</button>
                        </div>
                        <pre style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 400px; overflow: auto;">${escapeHTML(prompt.generatedPrompt)}</pre>
                        <div style="margin-top: 15px; text-align: right;">
                            <button onclick="copyPrompt('${promptId}')" style="margin-right: 10px; padding: 5px 10px;">Copy</button>
                            <button onclick="downloadSinglePrompt('${promptId}')" style="padding: 5px 10px;">Download .md</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(viewDiv);
                
            } catch (error) {
                workflowManager.recordApiFailure();
                alert(`Failed to load prompt: ${error.message}`);
            }
        }
        
        function closeTempView() {
            const view = document.getElementById('tempPromptView');
            if (view) view.remove();
        }

        function copyPrompt(promptId) {
            // For MVP, copy from the displayed content
            const pre = document.querySelector('#tempPromptView pre');
            if (pre) {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                    alert('Prompt copied to clipboard!');
                }).catch(() => {
                    alert('Failed to copy - please select and copy manually.');
                });
            }
        }

        async function downloadSinglePrompt(promptId) {
            try {
                const prompt = await window.APIClient.getPrompt(promptId);
                workflowManager.recordApiSuccess();
                
                const blob = new Blob([prompt.generatedPrompt], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompt-${promptId}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                closeTempView();
            } catch (error) {
                workflowManager.recordApiFailure();
                alert(`Download failed: ${error.message}`);
            }
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        async function viewStoryPrompt(storyIndex) {
            const promptId = workflowManager.getStoryPromptId(storyIndex);
            if (!promptId) {
                alert('No prompt found for this story.');
                return;
            }

            try {
                const prompt = await window.APIClient.getPrompt(promptId);
                workflowManager.recordApiSuccess();
                
                // Simple inline view for MVP
                const viewDiv = document.createElement('div');
                viewDiv.id = 'tempPromptView';
                viewDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;';
                
                viewDiv.innerHTML = `
                    <div style="background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow: auto; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3>Prompt for Story ${storyIndex + 1}</h3>
                            <button onclick="closeTempView()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer;">Close</button>
                        </div>
                        <pre style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 400px; overflow: auto;">${escapeHTML(prompt.generatedPrompt)}</pre>
                        <div style="margin-top: 15px; text-align: right;">
                            <button onclick="copyPrompt(${storyIndex})" style="margin-right: 10px; padding: 5px 10px;">Copy</button>
                            <button onclick="downloadSinglePrompt(${storyIndex})" style="padding: 5px 10px;">Download .md</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(viewDiv);
                
            } catch (error) {
                workflowManager.recordApiFailure();
                if (workflowManager.isApiDisabled()) {
                    showMaintenanceBanner();
                }
                alert(`Failed to load prompt: ${error.message}`);
            }
        }

        function closeTempView() {
            const view = document.getElementById('tempPromptView');
            if (view) view.remove();
        }

        function copyPrompt(storyIndex) {
            const promptId = workflowManager.getStoryPromptId(storyIndex);
            // For MVP, copy from the displayed content
            const pre = document.querySelector('#tempPromptView pre');
            if (pre) {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                    alert('Prompt copied to clipboard!');
                }).catch(() => {
                    alert('Failed to copy - please select and copy manually.');
                });
            }
        }

        async function downloadSinglePrompt(storyIndex) {
            const promptId = workflowManager.getStoryPromptId(storyIndex);
            try {
                const prompt = await window.APIClient.getPrompt(promptId);
                workflowManager.recordApiSuccess();
                
                const blob = new Blob([prompt.generatedPrompt], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompt-story-${storyIndex + 1}-ecommerce.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                closeTempView();
            } catch (error) {
                workflowManager.recordApiFailure();
                alert(`Download failed: ${error.message}`);
            }
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showError(message, projectId) {
            const container = document.getElementById('storiesContainer');
            container.innerHTML = `
                <div class="error-container" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin: 20px;">
                    <h3>Error Loading Stories</h3>
                    <p>${message}</p>
                    <button onclick="loadAndRenderStories()" class="primary-btn" style="margin-right: 10px;">Retry</button>
                    <button onclick="goBackToWorkflow(${projectId})" class="btn btn-primary">Back to Workflow</button>
                </div>
            `;
        }

        function showBackToWorkflow(projectId) {
            const storiesGrid = document.getElementById('storiesContainer');
            storiesGrid.innerHTML = `
                <div class="error-container">
                    <button onclick="goBackToWorkflow(${projectId})" class="btn btn-primary">
                        Back to Workflow
                    </button>
                </div>
            `;
        }

        function goBackToWorkflow(projectId) {
            if (projectId) {
                window.location.href = `workflow.html?projectId=${projectId}`;
            } else {
                window.location.href = 'workflow.html';
            }
        }

        // Maintenance banner for circuit breaker
        function showMaintenanceBanner() {
            if (document.getElementById('maintenance-banner')) return;
            const banner = document.createElement('div');
            banner.id = 'maintenance-banner';
            banner.className = 'maintenance-banner';
            banner.innerHTML = `
                <div style="background: #ff6b6b; color: white; padding: 10px; text-align: center; margin: 10px;">
                    <strong>API Maintenance Mode</strong><br>
                    System temporarily unavailable. Retrying in 60s or <button onclick="location.reload()" style="background: white; color: #ff6b6b; border: none; padding: 2px 8px; cursor: pointer;">Refresh</button>
                </div>
            `;
            document.body.insertBefore(banner, document.body.firstChild);
        }
    </script>
</body>
</html>
