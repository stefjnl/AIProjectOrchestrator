<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Workflow - AI Orchestrator</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">&larr; Back to Home</a>
        <div class="header">
            <h1 id="projectTitle">Loading Project...</h1>
            <p id="projectDescription"></p>
        </div>

        <div class="workflow-stages">
            <!-- Stage 1: Requirements Analysis -->
            <div class="workflow-stage">
                <h3>1. Requirements Analysis</h3>
                <div class="stage-status" id="requirementsStatus">Not Started</div>
                <button id="startRequirementsBtn" disabled>Start Analysis</button>
            </div>

            <!-- Stage 2: Project Planning -->
            <div class="workflow-stage">
                <h3>2. Project Planning</h3>
                <div class="stage-status" id="planningStatus">Not Started</div>
                <button id="startPlanningBtn" disabled>Start Planning</button>
            </div>

            <!-- Stage 3: User Stories -->
            <div class="workflow-stage">
                <h3>3. User Stories</h3>
                <div class="stage-status" id="storiesStatus">Not Started</div>
                <button id="startStoriesBtn" disabled>Generate Stories</button>
            </div>

            <!-- Stage 4: Code Generation -->
            <div class="workflow-stage">
                <h3>4. Code Generation</h3>
                <div class="stage-status" id="codeStatus">Not Started</div>
                <button id="startCodeBtn" disabled>Generate Code</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/workflow.js"></script>
    <script>
        let workflowManager;

        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');

            if (!projectId) {
                alert('No project ID provided. Redirecting to home.');
                window.location.href = '/';
                return;
            }

            workflowManager = new WorkflowManager(projectId);
            workflowManager.loadState();
            await workflowManager.checkApprovedReviews();

            try {
                const project = await window.APIClient.getProject(projectId);
                displayProjectInfo(project);
                workflowManager.updateWorkflowUI(); // Update UI after project info is loaded
            } catch (error) {
                alert('Error loading project: ' + error.message + '. Redirecting to home.');
                window.location.href = '/';
            }
        });

        function displayProjectInfo(project) {
            document.title = `${project.name} - Workflow`;
            document.getElementById('projectTitle').textContent = project.name;
            document.getElementById('projectDescription').textContent = project.description;
        }

        // Stage 1: Requirements Analysis
        async function startRequirementsAnalysis() {
            try {
                const project = await window.APIClient.getProject(workflowManager.projectId);
                const request = {
                    projectId: workflowManager.projectId,
                    projectDescription: project.description,
                    context: "",
                    constraints: []
                };

                const response = await window.APIClient.analyzeRequirements(request);
                workflowManager.setRequirementsAnalysisId(response.analysisId);
                workflowManager.setRequirementsPending(true);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('Requirements analysis submitted for review. Please check the review queue.');
                window.location.href = '../reviews/queue.html';
            } catch (error) {
                alert('Error starting requirements analysis: ' + error.message);
            }
        }

        // Stage 2: Project Planning
        async function startProjectPlanning() {
            try {
                const canCreate = await window.APIClient.canCreateProjectPlan(workflowManager.state.requirementsAnalysisId);
                if (!canCreate) {
                    alert('Cannot start project planning. Requirements must be approved first.');
                    return;
                }

                const request = {
                    requirementsAnalysisId: workflowManager.state.requirementsAnalysisId,
                    preferences: {}
                };

                const response = await window.APIClient.createProjectPlan(request);
                workflowManager.setProjectPlanningId(response.planningId);
                workflowManager.setPlanningPending(true);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('Project planning submitted for review. Please check the review queue.');
                window.location.href = '../reviews/queue.html';
            } catch (error) {
                alert('Error starting project planning: ' + error.message);
            }
        }

        // Stage 3: Story Generation
        async function startStoryGeneration() {
            try {
                const canGenerate = await window.APIClient.canGenerateStories(workflowManager.state.projectPlanningId);
                if (!canGenerate) {
                    alert('Cannot generate stories. Project planning must be approved first.');
                    return;
                }

                const request = {
                    planningId: workflowManager.state.projectPlanningId
                };

                const response = await window.APIClient.generateStories(request);
                workflowManager.setStoryGenerationId(response.generationId);
                workflowManager.setStoriesPending(true);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('User stories submitted for review. Please check the review queue.');
                window.location.href = '../reviews/queue.html';
            } catch (error) {
                alert('Error generating stories: ' + error.message);
            }
        }

        // Stage 4: Code Generation
        async function startCodeGeneration() {
            try {
                const canGenerate = await window.APIClient.canGenerateCode(workflowManager.state.storyGenerationId);
                if (!canGenerate) {
                    alert('Cannot generate code. User stories must be approved first.');
                    return;
                }

                const request = {
                    storyGenerationId: workflowManager.state.storyGenerationId
                };

                const response = await window.APIClient.generateCode(request);
                workflowManager.setCodeGenerationId(response.generationId);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('Code generation submitted for review. Please check the review queue.');
                window.location.href = '../reviews/queue.html';
            } catch (error) {
                alert('Error generating code: ' + error.message);
            }
        }
    </script>
</body>
</html>