<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Workflow - AI Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div class="container">
        <div class="main-nav-buttons">
            <a href="/projects/create.html"><button class="btn-primary">Create New Project</button></a>
            <a href="/projects/list.html"><button class="btn-secondary">View All Projects</button></a>
            <a href="/reviews/queue.html"><button class="btn-secondary">Go To Review Queue</button></a>
            <a href="#" id="storiesOverviewLink" style="display: none;"><button class="btn-secondary">Manage
                    Stories</button></a>
        </div>
        <a href="/index.html" class="back-link">&larr; Back to Home</a>
        <div class="header">
            <h1 id="projectTitle">Loading Project...</h1>
            <!-- Add immediately after the project title, before workflow-container -->
            <div class="progress-header">
                <div class="progress-info">
                    <h2 class="progress-title">Project Progress</h2>
                    <div class="progress-stats">
                        <span id="progressPercentage">0%</span>
                        <span class="progress-separator">â€¢</span>
                        <span id="progressSteps">0 of 4 stages completed</span>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-milestones">
                        <div class="milestone" data-stage="requirements">
                            <div class="milestone-dot" id="milestone-requirements"></div>
                            <span class="milestone-label">Requirements</span>
                        </div>
                        <div class="milestone" data-stage="planning">
                            <div class="milestone-dot" id="milestone-planning"></div>
                            <span class="milestone-label">Planning</span>
                        </div>
                        <div class="milestone" data-stage="stories">
                            <div class="milestone-dot" id="milestone-stories"></div>
                            <span class="milestone-label">Stories</span>
                        </div>
                        <div class="milestone" data-stage="prompts">
                            <div class="milestone-dot" id="milestone-prompts"></div>
                            <span class="milestone-label">Prompts</span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="projectDescription"></p>
        </div>
        <div class="reset-workflow-container">
            <button id="resetWorkflowBtn" class="btn-secondary" onclick="workflowManager.resetState()"
                style="float: right; margin-left: 10px;">Reset Workflow</button>
        </div>

        <div class="workflow-container">
            <!-- Stage 1: Requirements Analysis -->
            <div class="stage-card">
                <div class="workflow-stage">
                    <h3 class="stage-title">1. Requirements Analysis</h3>
                    <div class="status-badge status-not-started" id="requirementsStatus">Not Started</div>
                    <button id="startRequirementsBtn" class="btn-primary" onclick="startRequirementsAnalysis()">Start
                        Analysis</button>
                </div>
            </div>

            <!-- Stage 2: Project Planning -->
            <div class="stage-card">
                <div class="workflow-stage">
                    <h3 class="stage-title">2. Project Planning</h3>
                    <div class="status-badge status-not-started" id="planningStatus">Not Started</div>
                    <button id="startPlanningBtn" class="btn-primary" onclick="startProjectPlanning()">Start
                        Planning</button>
                </div>
            </div>

            <!-- Stage 3: User Stories -->
            <div class="stage-card">
                <div class="workflow-stage">
                    <h3 class="stage-title">3. User Stories</h3>
                    <div class="status-badge status-not-started" id="storiesStatus">Not Started</div>
                    <button id="startStoriesBtn" class="btn-primary" onclick="startStoryGeneration()">Generate
                        Stories</button>
                </div>
            </div>

            <!-- Stage 4: Prompt Generation -->
            <div class="stage-card">
                <div class="workflow-stage" id="promptStage">
                    <h3 class="stage-title">4. Prompt Generation</h3>
                    <div class="status-badge status-ready" id="promptStageStatus">Ready</div>
                    <div class="stage-actions">
                        <button id="viewAllPromptsBtn" class="btn-primary">View All Prompts</button>
                        <button id="downloadResultsBtn" class="btn-secondary">Download Results</button>
                    </div>
                    <div class="completion-dashboard">
                        <div class="stats-summary" id="dynamicStats">
                            <span>Loading stats...</span>
                        </div>
                        <button id="refreshStatsBtn" onclick="initStage4UI()" class="btn-secondary"
                            style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">Refresh Status</button>
                    </div>
                    <div class="stage-progress" id="promptProgress" style="display: none;">
                        <div class="progress-summary">
                            <span id="promptProgressText">0 of 0 prompts approved</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage 5: Code Generation -->
            <div class="stage-card">
                <div class="workflow-stage">
                    <h3 class="stage-title">5. Code Generation</h3>
                    <div class="status-badge status-not-started" id="codeStatus">Not Started</div>
                    <button id="startCodeBtn" class="btn-primary" onclick="startCodeGeneration()">Generate Code</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/workflow.js"></script>
    <script>
        let workflowManager;

        window.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');

            if (!projectId) {
                alert('No project ID provided. Redirecting to home.');
                window.location.href = '/';
                return;
            }

            // Wait for WorkflowManager to be defined before instantiation
            function waitForWorkflowManager() {
                return new Promise((resolve) => {
                    if (typeof WorkflowManager !== 'undefined') {
                        resolve();
                    } else {
                        const checkInterval = setInterval(() => {
                            if (typeof WorkflowManager !== 'undefined') {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 50); // Check every 50ms
                    }
                });
            }

            await waitForWorkflowManager();
            workflowManager = new WorkflowManager(projectId);

            // Show loading state
            document.body.classList.add('loading');

            // Load state from API instead of localStorage
            try {
                await workflowManager.loadStateFromAPI();
                await workflowManager.checkApprovedStatus();

                // NEW: Check for stories management redirect
                // Removed stories management redirect check

                // Add progression checking
                // Removed stage progression check for stories management

                // Enhanced initialization to load approved stories
                await workflowManager.checkStoryPromptApprovals();

                // Initialize Stage 4 dynamic UI if enabled
                if (workflowManager.state.enableDynamicStage4) {
                    initStage4UI();
                }

                // Show "Manage Stories" button if stories are approved
                updateStoriesOverviewLink();

                // Start polling for updates
                workflowManager.startPolling();

                // Hide loading state
                document.body.classList.remove('loading');

            } catch (error) {
                console.error('Failed to initialize workflow:', error);
                alert('Failed to load workflow. Please try again.');
                document.body.classList.remove('loading');
            }

            try {
                const project = await window.APIClient.getProject(projectId);
                workflowManager.recordApiSuccess();
                // Update project info directly
                document.getElementById('projectTitle').textContent = project.name;
                document.getElementById('projectDescription').textContent = project.description;
                workflowManager.updateWorkflowUI(); // Update UI after project info is loaded
                updateStoriesOverviewLink(); // Update stories overview link visibility
            } catch (error) {
                workflowManager.recordApiFailure();
                if (workflowManager.isApiDisabled()) {
                    showMaintenanceBanner();
                }
                // Fallback to mock project data
                document.getElementById('projectTitle').textContent = 'Demo Project';
                document.getElementById('projectDescription').textContent = 'This is a demonstration project for testing the workflow.';
                workflowManager.updateWorkflowUI();
                updateStoriesOverviewLink(); // Update stories overview link visibility
                console.warn(`Using demo data due to API error: ${error.message}`);
            }

            // Page visibility listener for polling optimization
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    workflowManager.stopPolling();
                } else {
                    workflowManager.startPolling();
                    // Refresh state when tab becomes visible
                    workflowManager.refreshState().catch(console.error);
                }
            });

            // Cleanup on page unload
            window.addEventListener('beforeunload', function () {
                workflowManager.stopPolling();
            });
        });

        // Enhanced helper function with micro-interaction support
        async function handleStageStart(buttonId, statusId, startFunction) {
            const button = document.getElementById(buttonId);
            const status = document.getElementById(statusId);
            const card = button ? button.closest('.stage-card') : null;

            if (!button || !status) {
                console.error('Button or status element not found for handleStageStart');
                return;
            }

            // Store original button content for restoration
            const originalButtonText = button.innerHTML;

            // Apply enhanced loading state with micro-interaction
            button.classList.add('loading');
            button.disabled = true;
            if (card) {
                card.classList.add('processing');
            }

            // Update status with processing animation
            status.textContent = 'Processing...';
            status.classList.add('transitioning');
            setTimeout(() => {
                status.className = 'status-badge status-in-progress';
                status.classList.remove('transitioning');
            }, 200);

            try {
                await startFunction(button, card);

                // Success micro-interactions - now handled by caller
                // Update progress indicator from caller if needed

                // Reset states after brief success display (before redirect)
                setTimeout(() => {
                    try {
                        if (button) {
                            button.classList.remove('loading', 'success');
                            if (card) {
                                card.classList.remove('processing', 'completing');
                            }
                        }
                    } catch (resetError) {
                        console.warn('Error resetting UI states:', resetError);
                    }
                }, 800); // Shorter timeout since we're redirecting

            } catch (error) {
                // Error state - remove all animation classes
                try {
                    button.classList.remove('loading', 'success');
                    if (card) {
                        card.classList.remove('processing', 'completing');
                    }
                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                } catch (resetError) {
                    console.warn('Error resetting UI states on error:', resetError);
                }

                // Reset status to previous state
                if (typeof workflowManager !== 'undefined') {
                    workflowManager.updateWorkflowUI();
                }

                alert(`Error: ${error.message}`);

                // Provide user with option to retry
                const userChoice = confirm('Would you like to try again? Cancel to continue without retrying.');
                if (userChoice) {
                    // Retry the operation with fresh animation states
                    await handleStageStart(buttonId, statusId, startFunction);
                }
            }
        }

        // Stage 1: Requirements Analysis
        function startRequirementsAnalysis() {
            handleStageStart('startRequirementsBtn', 'requirementsStatus', async (button, card) => {
                try {
                    // Set generating state
                    workflowManager.setRequirementsGenerating(true);
                    workflowManager.updateWorkflowUI();

                    const project = await window.APIClient.getProject(workflowManager.projectId);
                    const request = {
                        ProjectDescription: project.description,
                        AdditionalContext: "",
                        Constraints: "",
                        ProjectId: workflowManager.projectId
                    };

                    const response = await window.APIClient.analyzeRequirements(request);
                    workflowManager.setRequirementsAnalysisId(response.analysisId);
                    workflowManager.setRequirementsPending(true);
                    workflowManager.setRequirementsGenerating(false); // Clear generating state
                    // Don't save state - will be updated by polling
                    workflowManager.updateWorkflowUI();

                    // Success micro-interactions
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.classList.add('success');
                        }
                        if (card) {
                            card.classList.remove('processing');
                            card.classList.add('completing');
                        }
                        workflowManager.updateProgressIndicator();
                    } catch (uiError) {
                        console.warn('UI success update failed:', uiError);
                    }

                    // Show success message
                    alert('Requirements analysis submitted for review. Please check the review queue.');

                    // Reset animations before redirect
                    setTimeout(() => {
                        try {
                            if (button) button.classList.remove('success');
                            if (card) card.classList.remove('completing');
                        } catch (resetError) {
                            console.warn('Error resetting UI states:', resetError);
                        }
                    }, 800);

                    window.location.href = `/reviews/queue.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
                } catch (error) {
                    // Error state - remove animations and reset
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.disabled = false;
                        }
                        if (card) {
                            card.classList.remove('processing');
                        }
                        workflowManager.setRequirementsGenerating(false);
                        workflowManager.updateWorkflowUI();
                    } catch (resetError) {
                        console.warn('Error resetting UI states on error:', resetError);
                    }
                    throw error; // Re-throw to be handled by handleStageStart
                }
            });
        }

        // Stage 2: Project Planning
        function startProjectPlanning() {
            handleStageStart('startPlanningBtn', 'planningStatus', async (button, card) => {
                try {
                    // Set generating state
                    workflowManager.setPlanningGenerating(true);
                    workflowManager.updateWorkflowUI();

                    const canCreate = await window.APIClient.canCreateProjectPlan(workflowManager.state.requirementsAnalysisId);
                    if (!canCreate) {
                        workflowManager.setPlanningGenerating(false); // Clear generating state
                        workflowManager.updateWorkflowUI();
                        throw new Error('Cannot start project planning. Requirements must be approved first.');
                    }

                    const request = {
                        requirementsAnalysisId: workflowManager.state.requirementsAnalysisId,
                        preferences: {}
                    };

                    const response = await window.APIClient.createProjectPlan(request);
                    workflowManager.setProjectPlanningId(response.planningId);
                    workflowManager.setPlanningPending(true);
                    workflowManager.setPlanningGenerating(false); // Clear generating state
                    // Don't save state - will be updated by polling
                    workflowManager.updateWorkflowUI();

                    // Success micro-interactions
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.classList.add('success');
                        }
                        if (card) {
                            card.classList.remove('processing');
                            card.classList.add('completing');
                        }
                        workflowManager.updateProgressIndicator();
                    } catch (uiError) {
                        console.warn('UI success update failed:', uiError);
                    }

                    // Show success message
                    alert('Project planning submitted for review. Please check the review queue.');

                    // Reset animations before redirect
                    setTimeout(() => {
                        try {
                            if (button) button.classList.remove('success');
                            if (card) card.classList.remove('completing');
                        } catch (resetError) {
                            console.warn('Error resetting UI states:', resetError);
                        }
                    }, 800);

                    window.location.href = `/reviews/queue.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
                } catch (error) {
                    // Error state - remove animations and reset
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.disabled = false;
                        }
                        if (card) {
                            card.classList.remove('processing');
                        }
                        workflowManager.setPlanningGenerating(false);
                        workflowManager.updateWorkflowUI();
                    } catch (resetError) {
                        console.warn('Error resetting UI states on error:', resetError);
                    }
                    throw error; // Re-throw to be handled by handleStageStart
                }
            });
        }

        // Stage 3: Story Generation - Simplified redirect per proposal
        function startStoryGeneration() {
            handleStageStart('startStoriesBtn', 'storiesStatus', async (button, card) => {
                try {
                    // Set generating state
                    workflowManager.setStoriesGenerating(true);
                    workflowManager.updateWorkflowUI();

                    const canGenerate = await window.APIClient.canGenerateStories(workflowManager.state.projectPlanningId);
                    if (!canGenerate) {
                        workflowManager.setStoriesGenerating(false); // Clear generating state
                        workflowManager.updateWorkflowUI();
                        throw new Error('Cannot generate stories. Project planning must be approved first.');
                    }

                    const request = {
                        planningId: workflowManager.state.projectPlanningId
                    };

                    const response = await window.APIClient.generateStories(request);
                    workflowManager.setStoryGenerationId(response.generationId);
                    workflowManager.setStoriesPending(true);
                    workflowManager.setStoriesGenerating(false); // Clear generating state
                    // Don't save state - will be updated by polling
                    workflowManager.updateWorkflowUI();

                    // Success micro-interactions
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.classList.add('success');
                        }
                        if (card) {
                            card.classList.remove('processing');
                            card.classList.add('completing');
                        }
                        workflowManager.updateProgressIndicator();
                    } catch (uiError) {
                        console.warn('UI success update failed:', uiError);
                    }

                    // Show success message
                    workflowManager.showTemporaryMessage('User stories submitted for review. Check the review queue, then return here to continue.', 'info');

                    // Reset animations before redirect
                    setTimeout(() => {
                        try {
                            if (button) button.classList.remove('success');
                            if (card) card.classList.remove('completing');
                        } catch (resetError) {
                            console.warn('Error resetting UI states:', resetError);
                        }
                    }, 800);

                    window.location.href = `/reviews/queue.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
                } catch (error) {
                    // Error state - remove animations and reset
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.disabled = false;
                        }
                        if (card) {
                            card.classList.remove('processing');
                        }
                        workflowManager.setStoriesGenerating(false);
                        workflowManager.updateWorkflowUI();
                    } catch (resetError) {
                        console.warn('Error resetting UI states on error:', resetError);
                    }
                    throw error; // Re-throw to be handled by handleStageStart
                }
            });
        }

        // Stage 4: Code Generation
        function startCodeGeneration() {
            handleStageStart('startCodeBtn', 'codeStatus', async (button, card) => {
                try {
                    const canGenerate = await window.APIClient.canGenerateCode(workflowManager.state.storyGenerationId);
                    if (!canGenerate) {
                        throw new Error('Cannot generate code. User stories must be approved first.');
                    }

                    const request = {
                        storyGenerationId: workflowManager.state.storyGenerationId
                    };

                    const response = await window.APIClient.generateCode(request);
                    workflowManager.setCodeGenerationId(response.generationId);
                    // This is the final stage, so it doesn't go to pending review in the same way
                    // Don't save state - will be updated by polling
                    workflowManager.updateWorkflowUI();

                    // Success micro-interactions for final stage
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.classList.add('success');
                        }
                        if (card) {
                            card.classList.remove('processing');
                            card.classList.add('completing');
                        }
                        workflowManager.updateProgressIndicator();
                    } catch (uiError) {
                        console.warn('UI success update failed:', uiError);
                    }

                    // Show success message
                    alert('Code generation has been completed!');

                    // Longer celebration for final completion
                    setTimeout(() => {
                        try {
                            if (button) button.classList.remove('success');
                            if (card) card.classList.remove('completing');
                        } catch (resetError) {
                            console.warn('Error resetting UI states:', resetError);
                        }
                    }, 2000);

                    // Optional: redirect or update UI to show completion
                } catch (error) {
                    // Error state - remove animations and reset
                    try {
                        if (button) {
                            button.classList.remove('loading');
                            button.disabled = false;
                        }
                        if (card) {
                            card.classList.remove('processing');
                        }
                        workflowManager.updateWorkflowUI();
                    } catch (resetError) {
                        console.warn('Error resetting UI states on error:', resetError);
                    }
                    throw error; // Re-throw to be handled by handleStageStart
                }
            });
        }

        // Add these functions to the existing script section:

        // Removed stories management redirect function

        // Stage 4 Management Functions - Manual navigation only
        function goToStoriesManagement() {
            if (!workflowManager.state.storiesApproved) {
                alert('Stories must be approved before managing prompts.');
                return;
            }

            // Show message instead of redirecting
            alert('Stories Management is currently disabled. Please use the main navigation to access stories.');
        }

        function continueToCodeGeneration() {
            const progress = workflowManager.getPromptCompletionProgress();
            if (progress.approved < progress.total) {
                alert(`Please approve ${progress.total - progress.approved} more prompts before continuing to code generation.`);
                return;
            }
            // In production, redirect to code generation stage
            workflowManager.showTemporaryMessage('All prompts approved! Proceeding to code generation...', 'success');
            // window.location.href = 'code-generation.html?projectId=' + workflowManager.projectId;
        }

        // Completion View for Stage 4 - Simplified dashboard per proposal
        function updateStage4UI() {
            const manageBtn = document.getElementById('manageStoriesBtn');
            const continueBtn = document.getElementById('continueToCodeBtn');
            const progressDiv = document.getElementById('promptProgress');
            const progressText = document.getElementById('promptProgressText');
            const statusDiv = document.getElementById('promptStageStatus');

            if (!manageBtn || !continueBtn) return;

            if (!workflowManager.state.storiesApproved) {
                // Stories not approved yet
                manageBtn.disabled = true;
                manageBtn.textContent = 'Awaiting Story Approval';
                statusDiv.textContent = 'Waiting';
                statusDiv.className = 'stage-status waiting';
                progressDiv.style.display = 'none';
            } else {
                // Stories approved - enable management and show completion view
                const progress = workflowManager.getPromptCompletionProgress();

                manageBtn.disabled = false;
                progressDiv.style.display = 'block';

                // Completion dashboard mode
                if (progress.approved === progress.total && progress.total > 0) {
                    // Full completion view
                    manageBtn.textContent = 'View All Prompts';
                    statusDiv.textContent = 'Complete - Project Ready';
                    statusDiv.className = 'stage-status complete';

                    // Enhanced progress with summary stats
                    const summaryHtml = `
                        <div class="completion-summary">
                            <p><strong>Project Summary:</strong></p>
                            <ul>
                                <li>Total Stories: ${progress.total}</li>
                                <li>Generated Prompts: ${progress.generated}</li>
                                <li>Approved Prompts: ${progress.approved}</li>
                                <li>Pending Reviews: ${progress.pending}</li>
                                <li>Progress: ${progress.percentComplete}%</li>
                            </ul>
                            <button onclick="downloadAllApprovedFromWorkflow()" class="btn btn-success" style="margin-top: 10px;">
                                Download All Approved Prompts
                            </button>
                        </div>
                    `;
                    progressDiv.innerHTML = `
                        <div class="progress-summary">
                            <span id="promptProgressText">${progressText.textContent}</span>
                        </div>
                        ${summaryHtml}
                        ${document.getElementById('promptProgressBar') ? '' : updateProgressBar(progress).outerHTML}
                    `;
                } else {
                    // Standard management view
                    manageBtn.textContent = 'Manage Stories & Prompts';
                    statusDiv.textContent = 'Ready';
                    statusDiv.className = 'stage-status ready';

                    // Standard progress text
                    if (progress.total > 0) {
                        const parts = [];
                        if (progress.approved > 0) parts.push(`${progress.approved} approved`);
                        if (progress.pending > 0) parts.push(`${progress.pending} pending`);
                        if (progress.notStarted > 0) parts.push(`${progress.notStarted} not started`);

                        progressText.textContent = `${progress.approved}/${progress.total} prompts approved` +
                            (parts.length > 1 ? ` (${parts.join(', ')})` : '');

                        // Progress bar
                        updateProgressBar(progress);
                    }
                }

                // Enable continue button if all prompts approved
                continueBtn.disabled = progress.approved < progress.total;
                if (progress.approved === progress.total && progress.total > 0) {
                    continueBtn.textContent = 'Continue to Code Generation â†’';
                } else {
                    continueBtn.textContent = `Complete ${progress.total - progress.approved} more prompts to continue`;
                }
            }
        }

        // Enhanced Stage 3â†’4 transition with feature flag - Manual navigation only
        // Removed stage progression check function for stories management

        // Helper for completion view download
        function downloadAllApprovedFromWorkflow() {
            // Show message instead of redirecting to overview
            alert('Bulk download is currently disabled. Please use the Download Results button instead.');
        }

        function updateProgressBar(progress) {
            let progressBar = document.getElementById('promptProgressBar');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.id = 'promptProgressBar';
                progressBar.className = 'progress-bar';
                progressBar.innerHTML = `
                    <div class="progress-bar-fill" id="promptProgressFill" style="width: ${progress.percentComplete}%"></div>
                    <div class="progress-bar-text" id="promptProgressPercent">${progress.percentComplete}%</div>
                `;
                return progressBar; // Return for insertion in completion view
            }

            const fill = document.getElementById('promptProgressFill');
            const percentText = document.getElementById('promptProgressPercent');

            if (fill && percentText) {
                fill.style.width = `${progress.percentComplete}%`;
                percentText.textContent = `${progress.percentComplete}%`;
            }
            return progressBar;
        }

        // Stage 4: View All Prompts - Redirect to stories management
        function viewAllPrompts() {
            if (!workflowManager.state.storyGenerationId) {
                alert('No approved stories found. Complete Stage 3 first.');
                return;
            }

            // Redirect to stories overview page
            window.location.href = `/projects/stories-overview.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
        }

        // Stage 4: Download Results - Bulk download all approved prompts
        async function downloadResults() {
            try {
                if (!workflowManager.state.storyGenerationId) {
                    alert('No approved stories found. Complete Stage 3 first.');
                    return;
                }

                // Get all approved stories and their prompts
                const stories = await window.APIClient.getApprovedStories(workflowManager.state.storyGenerationId);
                const approvedPrompts = [];

                for (let i = 0; i < stories.length; i++) {
                    const promptId = workflowManager.getStoryPromptId(i);
                    if (promptId && workflowManager.getStoryPromptStatus(i) === 'Approved') {
                        const prompt = await window.APIClient.getPrompt(promptId);
                        approvedPrompts.push({
                            storyIndex: i,
                            storyTitle: stories[i].title,
                            content: prompt.generatedPrompt
                        });
                    }
                }

                if (approvedPrompts.length === 0) {
                    alert('No approved prompts available for download.');
                    return;
                }

                // Create ZIP file content or multiple .md files
                downloadPromptsAsZip(approvedPrompts);

            } catch (error) {
                alert('Error downloading results: ' + error.message);
            }
        }

        // Helper function for ZIP download
        function downloadPromptsAsZip(prompts) {
            // Simple approach: Download individual .md files
            prompts.forEach(prompt => {
                const blob = new Blob([prompt.content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `prompt-${prompt.storyIndex}-${prompt.storyTitle.replace(/\s+/g, '-')}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // Ensure buttons have proper event handlers
        window.addEventListener('DOMContentLoaded', function () {
            // Add event listeners to Stage 4 buttons
            const viewPromptsBtn = document.getElementById('viewAllPromptsBtn');
            const downloadBtn = document.getElementById('downloadResultsBtn');

            if (viewPromptsBtn) {
                viewPromptsBtn.addEventListener('click', viewAllPrompts);
            }

            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadResults);
            }
        });

        // Stage 4: Initialize dynamic stats
        function initStage4UI() {
            if (!workflowManager.state.enableDynamicStage4) {
                // Fallback to hardcoded if flag disabled
                document.getElementById('dynamicStats').innerHTML = `
                    <span>âœ… Stories Ready for Prompts</span> |
                    <span>ðŸ“¥ No Prompts Generated</span> |
                    <span>ðŸ“¤ Ready to Start</span>
                `;
                return;
            }

            try {
                const progress = workflowManager.getPromptCompletionProgress();
                const statusEl = document.getElementById('promptStageStatus');

                // Determine status and messages based on workflow state
                let status = 'Not Started';
                let statusClass = 'not-started';
                let message = '';
                let displayGenerated = 'No';
                let displayApproved = 'Stories Not Approved';
                let statusText = 'Not Available';

                if (!workflowManager.state.storiesApproved) {
                    // Stories not approved yet
                    status = 'Not Started';
                    statusClass = 'not-started';
                    message = 'Stories need approval first';
                    displayApproved = 'Stories Not Approved';
                } else if (progress.approved > 0) {
                    // At least one story is individually approved
                    status = 'Ready';
                    statusClass = 'ready';
                    message = `${progress.approved} stories ready for prompts`;
                    displayApproved = `${progress.approved} Stories Approved`;
                    statusText = 'Ready to Start';
                } else if (progress.total > 0) {
                    // Stories approved but no individual stories approved yet
                    status = 'Waiting';
                    statusClass = 'waiting';
                    message = 'Individual story approval needed';
                    displayApproved = 'Stories Approved';
                    statusText = 'Pending Individual Approval';
                } else {
                    // Stories approved but no prompts generated yet
                    status = 'Ready';
                    statusClass = 'ready';
                    message = 'Stories Approved - Ready to Generate Prompts';
                    displayApproved = 'Stories Ready';
                    statusText = 'Ready to Start';
                }

                // Update status element
                statusEl.textContent = status;
                statusEl.className = `stage-status ${statusClass}`;

                // Update stats display with contextual information
                document.getElementById('dynamicStats').innerHTML = `
                    <span>âœ… ${displayApproved} Stories Approved</span> |
                    <span>ðŸ“¥ ${displayGenerated} Prompts Generated</span> |
                    <span>${statusText}</span>
                `;

                // Add contextual message below stats if needed
                const statsContainer = document.getElementById('dynamicStats').parentNode;
                let messageEl = statsContainer.querySelector('.stage-message');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.className = 'stage-message';
                    statsContainer.appendChild(messageEl);
                }
                messageEl.textContent = message;

                // Update button states based on status
                const viewBtn = document.getElementById('viewAllPromptsBtn');
                const downloadBtn = document.getElementById('downloadResultsBtn');

                if (viewBtn) {
                    viewBtn.disabled = !workflowManager.state.storiesApproved || !workflowManager.state.storyGenerationId;
                    viewBtn.textContent = 'Manage Stories & Prompts';
                }

                if (downloadBtn) {
                    downloadBtn.disabled = progress.approved === 0;
                    downloadBtn.textContent = status === 'Complete' ? 'Download All Approved' : 'Download Results';
                }

                workflowManager.recordApiSuccess();

            } catch (error) {
                console.error('Failed to initialize Stage 4 UI:', error);
                workflowManager.recordApiFailure();
                if (workflowManager.isApiDisabled()) {
                    showMaintenanceBanner();
                }
                // Fallback display
                document.getElementById('dynamicStats').innerHTML = `
                    <span>Error loading stats - <button onclick="initStage4UI()">Retry</button></span>
                `;
            }
        }

        // Update stories overview link visibility
        function updateStoriesOverviewLink() {
            const link = document.getElementById('storiesOverviewLink');
            if (link && workflowManager.state.storiesApproved && workflowManager.state.storyGenerationId) {
                link.href = `/projects/stories-overview.html?projectId=${encodeURIComponent(workflowManager.projectId)}`;
                link.style.display = 'inline-block';
            } else if (link) {
                link.style.display = 'none';
            }
        }

        // Maintenance banner for circuit breaker
        function showMaintenanceBanner() {
            if (document.getElementById('maintenance-banner')) return;
            const banner = document.createElement('div');
            banner.id = 'maintenance-banner';
            banner.className = 'maintenance-banner';
            banner.innerHTML = `
                <div style="background: #ff6b6b; color: white; padding: 10px; text-align: center; margin: 10px;">
                    <strong>API Maintenance Mode</strong><br>
                    System temporarily unavailable. Retrying in 60s or <button onclick="location.reload()" style="background: white; color: #ff6b6b; border: none; padding: 2px 8px; cursor: pointer;">Refresh</button>
                </div>
            `;
            document.body.insertBefore(banner, document.body.firstChild);
        }
    </script>
</body>

</html>