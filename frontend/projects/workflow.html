<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Workflow - AI Orchestrator</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">&larr; Back to Home</a>
        <div class="header">
            <h1 id="projectTitle">Loading Project...</h1>
            <p id="projectDescription"></p>
            <button id="resetWorkflowBtn" onclick="workflowManager.resetState()" style="float: right; margin-left: 10px;">Reset Workflow</button>
        </div>

        <div class="workflow-stages">
            <!-- Stage 1: Requirements Analysis -->
            <div class="workflow-stage">
                <h3>1. Requirements Analysis</h3>
                <div class="stage-status" id="requirementsStatus">Not Started</div>
                <button id="startRequirementsBtn" onclick="startRequirementsAnalysis()">Start Analysis</button>
            </div>

            <!-- Stage 2: Project Planning -->
            <div class="workflow-stage">
                <h3>2. Project Planning</h3>
                <div class="stage-status" id="planningStatus">Not Started</div>
                <button id="startPlanningBtn" onclick="startProjectPlanning()">Start Planning</button>
            </div>

            <!-- Stage 3: User Stories -->
            <div class="workflow-stage">
                <h3>3. User Stories</h3>
                <div class="stage-status" id="storiesStatus">Not Started</div>
                <button id="startStoriesBtn" onclick="startStoryGeneration()">Generate Stories</button>
            </div>

            <!-- Add after existing Stage 3 section -->

            <!-- Stage 4: Prompt Generation -->
            <div class="workflow-stage" id="promptStage">
                <h3>Prompt Generation</h3>
                <div class="stage-status" id="promptStageStatus">Not Started</div>
                
                <!-- Stories Container for Individual Prompt Generation -->
                <div id="storiesContainer" class="stories-container" style="display: none;">
                    <h4>Generate Prompts for Individual Stories</h4>
                    <div id="storiesList" class="stories-list">
                        <!-- Story cards populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Stage 5: Code Generation -->
            <div class="workflow-stage">
                <h3>5. Code Generation</h3>
                <div class="stage-status" id="codeStatus">Not Started</div>
                <button id="startCodeBtn" onclick="startCodeGeneration()">Generate Code</button>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/workflow.js"></script>
    <script>
        let workflowManager;

        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('projectId');

            if (!projectId) {
                alert('No project ID provided. Redirecting to home.');
                window.location.href = '/';
                return;
            }

            workflowManager = new WorkflowManager(projectId);
            workflowManager.loadState();

            // Force initial state for new projects if stale pending without ID
            if (workflowManager.state.requirementsPending && !workflowManager.state.requirementsAnalysisId) {
                workflowManager.setRequirementsPending(false);
                workflowManager.saveState();
            }

            await workflowManager.checkApprovedStatus();

            // Enhanced initialization to load approved stories
            await workflowManager.checkStoryPromptApprovals();

            // Load approved stories if available
            if (workflowManager.state.storiesApproved && workflowManager.state.storyGenerationId) {
                await loadApprovedStories();
            }

            try {
                const project = await window.APIClient.getProject(projectId);
                displayProjectInfo(project);
                workflowManager.updateWorkflowUI(); // Update UI after project info is loaded
            } catch (error) {
                // Instead of immediately redirecting, show error and give user options
                const userChoice = confirm(`Error loading project: ${error.message}. Would you like to try again? Cancel to go to home.`);
                if (userChoice) {
                    // Reload the page to try again
                    window.location.reload();
                } else {
                    // Redirect to home
                    window.location.href = '/';
                }
            }
        });

        function displayProjectInfo(project) {
            document.title = `${project.name} - Workflow`;
            document.getElementById('projectTitle').textContent = project.name;
            document.getElementById('projectDescription').textContent = project.description;
        }

        // Helper function to manage UI state during async operations
        async function handleStageStart(buttonId, statusId, startFunction) {
            const button = document.getElementById(buttonId);
            const status = document.getElementById(statusId);

            button.disabled = true;
            status.textContent = 'Generating...';
            status.className = 'stage-status generating';

            try {
                await startFunction();
                // Don't reset UI on success since we're redirecting to review queue
                // The UI will be reset when the user returns to this page
            } catch (error) {
                alert(`Error: ${error.message}`);
                // Reset UI on failure
                workflowManager.updateWorkflowUI();
                
                // Provide user with option to retry
                const userChoice = confirm('Would you like to try again? Cancel to continue without retrying.');
                if (userChoice) {
                    // Retry the operation
                    await handleStageStart(buttonId, statusId, startFunction);
                }
            }
        }

        // Stage 1: Requirements Analysis
        function startRequirementsAnalysis() {
            handleStageStart('startRequirementsBtn', 'requirementsStatus', async () => {
                try {
                    // Set generating state
                    workflowManager.setRequirementsGenerating(true);
                    workflowManager.saveState();
                    workflowManager.updateWorkflowUI();

                    const project = await window.APIClient.getProject(workflowManager.projectId);
                    const request = {
                        ProjectDescription: project.description,
                        AdditionalContext: "",
                        Constraints: "",
                        ProjectId: workflowManager.projectId
                    };

                    const response = await window.APIClient.analyzeRequirements(request);
                    workflowManager.setRequirementsAnalysisId(response.analysisId);
                    workflowManager.setRequirementsPending(true);
                    workflowManager.setRequirementsGenerating(false); // Clear generating state
                    workflowManager.saveState();
                    workflowManager.updateWorkflowUI();

                    alert('Requirements analysis submitted for review. Please check the review queue.');
                    window.location.href = '/reviews/queue.html';
                } catch (error) {
                    // Clear generating state on error
                    workflowManager.setRequirementsGenerating(false);
                    workflowManager.saveState();
                    workflowManager.updateWorkflowUI();
                    throw error; // Re-throw to be handled by handleStageStart
                }
            });
        }

        // Stage 2: Project Planning
        function startProjectPlanning() {
            handleStageStart('startPlanningBtn', 'planningStatus', async () => {
                // Set generating state
                workflowManager.setPlanningGenerating(true);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                const canCreate = await window.APIClient.canCreateProjectPlan(workflowManager.state.requirementsAnalysisId);
                if (!canCreate) {
                    workflowManager.setPlanningGenerating(false); // Clear generating state
                    workflowManager.saveState();
                    workflowManager.updateWorkflowUI();
                    throw new Error('Cannot start project planning. Requirements must be approved first.');
                }

                const request = {
                    requirementsAnalysisId: workflowManager.state.requirementsAnalysisId,
                    preferences: {}
                };

                const response = await window.APIClient.createProjectPlan(request);
                workflowManager.setProjectPlanningId(response.planningId);
                workflowManager.setPlanningPending(true);
                workflowManager.setPlanningGenerating(false); // Clear generating state
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('Project planning submitted for review. Please check the review queue.');
                window.location.href = '/reviews/queue.html';
            });
        }

        // Stage 3: Story Generation
        function startStoryGeneration() {
            handleStageStart('startStoriesBtn', 'storiesStatus', async () => {
                // Set generating state
                workflowManager.setStoriesGenerating(true);
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                const canGenerate = await window.APIClient.canGenerateStories(workflowManager.state.projectPlanningId);
                if (!canGenerate) {
                    workflowManager.setStoriesGenerating(false); // Clear generating state
                    workflowManager.saveState();
                    workflowManager.updateWorkflowUI();
                    throw new Error('Cannot generate stories. Project planning must be approved first.');
                }

                const request = {
                    planningId: workflowManager.state.projectPlanningId
                };

                const response = await window.APIClient.generateStories(request);
                workflowManager.setStoryGenerationId(response.generationId);
                workflowManager.setStoriesPending(true);
                workflowManager.setStoriesGenerating(false); // Clear generating state
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('User stories submitted for review. Please check the review queue.');
                window.location.href = '/reviews/queue.html';
            });
        }

        // Stage 4: Code Generation
        function startCodeGeneration() {
            handleStageStart('startCodeBtn', 'codeStatus', async () => {
                const canGenerate = await window.APIClient.canGenerateCode(workflowManager.state.storyGenerationId);
                if (!canGenerate) {
                    throw new Error('Cannot generate code. User stories must be approved first.');
                }

                const request = {
                    storyGenerationId: workflowManager.state.storyGenerationId
                };

                const response = await window.APIClient.generateCode(request);
                workflowManager.setCodeGenerationId(response.generationId);
                // This is the final stage, so it doesn't go to pending review in the same way
                workflowManager.saveState();
                workflowManager.updateWorkflowUI();

                alert('Code generation has been completed!');
                // Optional: redirect or update UI to show completion
            });
        }

        // Add these functions to the existing script section:

        // Enhanced initialization to load approved stories
        async function loadApprovedStories() {
            try {
                // For now, simulate story data - replace with actual API call when available
                const mockStories = [
                    {
                        title: "User Registration",
                        userType: "new user",
                        wantStatement: "create an account with email and password",
                        soThatStatement: "I can access personalized features"
                    },
                    {
                        title: "User Login",
                        userType: "registered user", 
                        wantStatement: "log into my account",
                        soThatStatement: "I can access my personal dashboard"
                    }
                    // Add more mock stories or implement actual API call
                ];
                
                workflowManager.state.approvedStories = mockStories;
                workflowManager.saveState();
                displayStoriesForPromptGeneration(mockStories);
            } catch (error) {
                console.error('Error loading approved stories:', error);
            }
        }

        function displayStoriesForPromptGeneration(stories) {
            const storiesContainer = document.getElementById('storiesContainer');
            const storiesList = document.getElementById('storiesList');
            
            if (!storiesContainer || !storiesList) return;
            
            storiesContainer.style.display = 'block';
            
            storiesList.innerHTML = stories.map((story, index) => `
                <div class="story-card" id="story-${index}">
                    <div class="story-header">
                        <h5>Story ${index + 1}: ${story.title}</h5>
                        <div class="prompt-status" id="promptStatus-${index}">Not Started</div>
                    </div>
                    <div class="story-content">
                        <p><strong>As a</strong> ${story.userType}</p>
                        <p><strong>I want</strong> ${story.wantStatement}</p>
                        <p><strong>So that</strong> ${story.soThatStatement}</p>
                    </div>
                    <div class="story-actions">
                        <button id="generatePrompt-${index}" 
                                onclick="generateStoryPrompt(${index})"
                                class="generate-prompt-btn">
                            Generate Prompt
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Update UI states for existing prompts
            workflowManager.updateStoryPromptUI();
        }

        async function generateStoryPrompt(storyIndex) {
            try {
                const canGenerate = await window.APIClient.canGeneratePrompt(
                    workflowManager.state.storyGenerationId, 
                    storyIndex
                );
                
                if (!canGenerate) {
                    alert('Cannot generate prompt. Stories must be approved first.');
                    return;
                }
                
                const preferences = {
                    framework: 'ASP.NET Core',
                    testingFramework: 'xUnit',
                    architecture: 'Clean Architecture'
                };
                
                const response = await window.APIClient.generatePrompt(
                    workflowManager.state.storyGenerationId,
                    storyIndex, 
                    preferences
                );
                
                workflowManager.setStoryPromptId(storyIndex, response.promptId);
                workflowManager.updateStoryPromptUI();
                
                alert(`Prompt generation started for Story ${storyIndex + 1}. Check the review queue.`);
                
                // Optional: Redirect to review queue
                // window.location.href = '../reviews/queue.html';
                
            } catch (error) {
                alert('Error generating prompt: ' + error.message);
                console.error('Prompt generation error:', error);
            }
        }

        async function viewPrompt(storyIndex) {
            const prompt = workflowManager.state.storyPrompts[storyIndex];
            if (prompt && prompt.promptId) {
                try {
                    const promptData = await window.APIClient.getPrompt(prompt.promptId);
                    
                    // Simple prompt display - open in new window for now
                    const promptWindow = window.open('', '_blank');
                    promptWindow.document.write(`
                        <html>
                            <head><title>Generated Prompt - Story ${storyIndex + 1}</title></head>
                            <body style="font-family: monospace; padding: 20px;">
                                <h2>Generated Coding Prompt</h2>
                                <button onclick="navigator.clipboard.writeText(document.getElementById('promptContent').textContent)">
                                    Copy to Clipboard
                                </button>
                                <hr>
                                <pre id="promptContent">${promptData.generatedPrompt}</pre>
                            </body>
                        </html>
                    `);
                } catch (error) {
                    alert('Error loading prompt: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
