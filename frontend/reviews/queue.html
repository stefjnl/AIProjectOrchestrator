<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Queue - AI Orchestrator</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">&larr; Back to Home</a>
        <h1>Review Queue</h1>
        <div id="reviewList">
            <p class="no-reviews">Loading pending reviews...</p>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', loadPendingReviews);

        async function loadPendingReviews() {
            try {
                const reviews = await window.APIClient.getPendingReviews();
                const reviewList = document.getElementById('reviewList');

                if (reviews.length === 0) {
                    reviewList.innerHTML = '<p class="no-reviews">No pending reviews at this time.</p>';
                    return;
                }

                reviewList.innerHTML = reviews.map(review => `
                    <div class="review-item" id="review-${review.id}">
                        <h3>${review.serviceName} - ${review.pipelineStage}</h3>
                        <div class="review-content">${review.content}</div>
                        <div class="review-actions">
                            <button class="approve" onclick="approveReview('${review.id}')"
                                    id="approve-${review.id}">Approve</button>
                            <button class="reject" onclick="rejectReview('${review.id}')"
                                    id="reject-${review.id}">Reject</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviewList').innerHTML = '<p class="no-reviews">Error loading reviews: ' + error.message + '</p>';
            }
        }

        async function approveReview(reviewId) {
            const approveBtn = document.getElementById(`approve-${reviewId}`);
            const rejectBtn = document.getElementById(`reject-${reviewId}`);

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            approveBtn.textContent = 'Approving...';

            try {
                await window.APIClient.approveReview(reviewId);
                alert('Review approved successfully!');
                await loadPendingReviews(); // Reload reviews after approval
            } catch (error) {
                alert('Error approving review: ' + error.message);
            } finally {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                approveBtn.textContent = 'Approve';
            }
        }

        async function rejectReview(reviewId) {
            const feedback = prompt('Please provide feedback for rejection:');
            if (!feedback) return; // User cancelled prompt

            const approveBtn = document.getElementById(`approve-${reviewId}`);
            const rejectBtn = document.getElementById(`reject-${reviewId}`);

            approveBtn.disabled = true;
            rejectBtn.disabled = true;
            rejectBtn.textContent = 'Rejecting...';

            try {
                await window.APIClient.rejectReview(reviewId, feedback);
                alert('Review rejected with feedback.');
                await loadPendingReviews(); // Reload reviews after rejection
            } catch (error) {
                alert('Error rejecting review: ' + error.message);
            } finally {
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                rejectBtn.textContent = 'Reject';
            }
        }
    </script>
</body>
</html>